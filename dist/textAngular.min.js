"use strict";angular.module("textAngular.DOM",["textAngular.factories"]).factory("taExecCommand",["taSelection","taBrowserTag","$document",function(taSelection,taBrowserTag,$document){function turnBlockIntoBlocks(element,options){for(var i=0;i<element.childNodes.length;i++){var _n=element.childNodes[i];_n.tagName&&_n.tagName.match(BLOCKELEMENTS)&&turnBlockIntoBlocks(_n,options)}if(null===element.parentNode)return element;if("<br>"===options)return element;var $target=angular.element(options);return $target[0].innerHTML=element.innerHTML,element.parentNode.insertBefore($target[0],element),element.parentNode.removeChild(element),$target}var listToDefault=function(listElement,defaultWrap){var $target,i,children=listElement.find("li");for(i=children.length-1;0<=i;i--)$target=angular.element("<"+defaultWrap+">"+children[i].innerHTML+"</"+defaultWrap+">"),listElement.after($target);listElement.remove(),taSelection.setSelectionToElementEnd($target[0])},listElementToSelfTag=function(list,listElement,selfTag,bDefault,defaultWrap){var $target,i,priorElement,nextElement,foundIndex,children=list.find("li");for(i=0;i<children.length;i++)if(children[i].outerHTML===listElement[0].outerHTML){0<(foundIndex=i)&&(priorElement=children[i-1]),i+1<children.length&&(nextElement=children[i+1]);break}var html="";if(bDefault?html+="<"+defaultWrap+">"+listElement[0].innerHTML+"</"+defaultWrap+">":(html+="<"+taBrowserTag(selfTag)+">",html+="<li>"+listElement[0].innerHTML+"</li>",html+="</"+taBrowserTag(selfTag)+">"),$target=angular.element(html),!priorElement)return listElement.remove(),list.after(angular.element(list[0].outerHTML)),list.after($target),list.remove(),void taSelection.setSelectionToElementEnd($target[0]);if(nextElement){list.parent();var html1="",listTag=list[0].nodeName.toLowerCase();for(html1+="<"+listTag+">",i=0;i<foundIndex;i++)html1+="<li>"+children[i].innerHTML+"</li>";html1+="</"+listTag+">";var html2="";for(html2+="<"+listTag+">",i=foundIndex+1;i<children.length;i++)html2+="<li>"+children[i].innerHTML+"</li>";html2+="</"+listTag+">",list.after(angular.element(html2)),list.after($target),list.after(angular.element(html1)),list.remove(),taSelection.setSelectionToElementEnd($target[0])}else listElement.remove(),list.after($target),taSelection.setSelectionToElementEnd($target[0])},selectLi=function(liElement){/(<br(|\/)>)$/i.test(liElement.innerHTML.trim())?taSelection.setSelectionBeforeElement(angular.element(liElement).find("br")[0]):taSelection.setSelectionToElementEnd(liElement)},listToList=function(listElement,newListTag){var $target=angular.element("<"+newListTag+">"+listElement[0].innerHTML+"</"+newListTag+">");listElement.after($target),listElement.remove(),selectLi($target.find("li")[0])},childElementsToList=function(elements,listElement,newListTag){for(var html="",i=0;i<elements.length;i++)html+="<"+taBrowserTag("li")+">"+elements[i].innerHTML+"</"+taBrowserTag("li")+">";var $target=angular.element("<"+newListTag+">"+html+"</"+newListTag+">");listElement.after($target),listElement.remove(),selectLi($target.find("li")[0])};return function(taDefaultWrap,topNode){return taDefaultWrap=taBrowserTag(taDefaultWrap),function(command,showUI,options,defaultTagAttributes){var i,$target,html,_nodes,next,optionsTagName,selectedElement,ourSelection,defaultWrapper=angular.element("<"+taDefaultWrap+">");try{var __h,_innerNode;taSelection.getSelection&&(ourSelection=taSelection.getSelection()),void 0!==(selectedElement=taSelection.getSelectionElement()).tagName&&("div"===selectedElement.tagName.toLowerCase()&&/taTextElement.+/.test(selectedElement.id)&&ourSelection&&ourSelection.start&&1===ourSelection.start.offset&&1===ourSelection.end.offset||"span"===selectedElement.tagName.toLowerCase()&&ourSelection&&ourSelection.start&&1===ourSelection.start.offset&&1===ourSelection.end.offset?(__h=selectedElement.innerHTML,/<br>/i.test(__h)&&(__h=__h.replace(/<br>/i,"&#8203;")),/<br\/>/i.test(__h)&&(__h=__h.replace(/<br\/>/i,"&#8203;")),/<span>(<span>)+/i.test(__h)&&(__h=__.replace(/<span>(<span>)+/i,"<span>")),/<\/span>(<\/span>)+/i.test(__h)&&(__h=__.replace(/<\/span>(<\/span>)+/i,"</span>")),/<span><\/span>/i.test(__h)&&(__h=__h.replace(/<span><\/span>/i,"")),_innerNode="<div>"+__h+"</div>",selectedElement.innerHTML=_innerNode,taSelection.setSelectionToElementEnd(selectedElement.childNodes[0]),selectedElement=taSelection.getSelectionElement()):"p"===selectedElement.tagName.toLowerCase()&&ourSelection&&ourSelection.start&&1===ourSelection.start.offset&&1===ourSelection.end.offset?(__h=selectedElement.innerHTML,/<br>/i.test(__h)&&(__h=__h.replace(/<br>/i,"&#8203;"),selectedElement.innerHTML=__h)):"li"===selectedElement.tagName.toLowerCase()&&ourSelection&&ourSelection.start&&ourSelection.start.offset===ourSelection.end.offset&&(__h=selectedElement.innerHTML,/<br>/i.test(__h)&&(__h=__h.replace(/<br>/i,""),selectedElement.innerHTML=__h)))}catch(e){}if(selectedElement){var $selected=angular.element(selectedElement),tagName=selectedElement&&selectedElement.tagName&&selectedElement.tagName.toLowerCase()||"";if("insertorderedlist"===command.toLowerCase()||"insertunorderedlist"===command.toLowerCase()){var selfTag=taBrowserTag("insertorderedlist"===command.toLowerCase()?"ol":"ul"),selectedElements=taSelection.getOnlySelectedElements();if(1<selectedElements.length&&("ol"===tagName||"ul"===tagName))return function(list,listElements,selfTag,bDefault,defaultWrap){var $target,i,j,priorElement,afterElement,children=list.find("li"),foundIndexes=[];for(i=0;i<children.length;i++)for(j=0;j<listElements.length;j++)children[i].isEqualNode(listElements[j])&&(foundIndexes[j]=i);0<foundIndexes[0]&&(priorElement=children[foundIndexes[0]-1]),foundIndexes[listElements.length-1]+1<children.length&&(afterElement=children[foundIndexes[listElements.length-1]+1]);var html="";if(bDefault)for(j=0;j<listElements.length;j++)html+="<"+defaultWrap+">"+listElements[j].innerHTML+"</"+defaultWrap+">",listElements[j].remove();else{for(html+="<"+taBrowserTag(selfTag)+">",j=0;j<listElements.length;j++)html+=listElements[j].outerHTML,listElements[j].remove();html+="</"+taBrowserTag(selfTag)+">"}if($target=angular.element(html),!priorElement)return list.after(angular.element(list[0].outerHTML)),list.after($target),list.remove(),void taSelection.setSelectionToElementEnd($target[0]);if(!afterElement)return list.after($target),void taSelection.setSelectionToElementEnd($target[0]);var html1="",listTag=list[0].nodeName.toLowerCase();for(html1+="<"+listTag+">",i=0;i<foundIndexes[0];i++)html1+="<li>"+children[i].innerHTML+"</li>";html1+="</"+listTag+">";var html2="";for(html2+="<"+listTag+">",i=foundIndexes[listElements.length-1]+1;i<children.length;i++)html2+="<li>"+children[i].innerHTML+"</li>";html2+="</"+listTag+">",list.after(angular.element(html2)),list.after($target),list.after(angular.element(html1)),list.remove(),taSelection.setSelectionToElementEnd($target[0])}($selected,selectedElements,selfTag,selfTag===tagName,taDefaultWrap);if(tagName===selfTag)return $selected[0].childNodes.length!==selectedElements.length&&1===selectedElements.length?($selected=angular.element(selectedElements[0]),listElementToSelfTag($selected.parent(),$selected,selfTag,!0,taDefaultWrap)):listToDefault($selected,taDefaultWrap);if("li"===tagName&&$selected.parent()[0].tagName.toLowerCase()===selfTag&&1===$selected.parent().children().length)return listToDefault($selected.parent(),taDefaultWrap);if("li"===tagName&&$selected.parent()[0].tagName.toLowerCase()!==selfTag&&1===$selected.parent().children().length)return listToList($selected.parent(),selfTag);if(tagName.match(BLOCKELEMENTS)&&!$selected.hasClass("ta-bind")){if(selectedElements.length&&$selected[0].childNodes.length!==selectedElements.length&&1===selectedElements.length)return $selected=angular.element(selectedElements[0]),listElementToSelfTag($selected.parent(),$selected,selfTag,selfTag===tagName,taDefaultWrap);if("ol"===tagName||"ul"===tagName)return listToList($selected,selfTag);var childBlockElements=!1;return angular.forEach($selected.children(),function(elem){elem.tagName.match(BLOCKELEMENTS)&&(childBlockElements=!0)}),childElementsToList(childBlockElements?$selected.children():[angular.element("<div>"+selectedElement.innerHTML+"</div>")[0]],$selected,selfTag)}if(tagName.match(BLOCKELEMENTS)){if(0===(_nodes=taSelection.getOnlySelectedElements()).length)$target=angular.element("<"+selfTag+"><li>"+selectedElement.innerHTML+"</li></"+selfTag+">"),$selected.html(""),$selected.append($target);else{if(1===_nodes.length&&("ol"===_nodes[0].tagName.toLowerCase()||"ul"===_nodes[0].tagName.toLowerCase()))return _nodes[0].tagName.toLowerCase()===selfTag?listToDefault(angular.element(_nodes[0]),taDefaultWrap):listToList(angular.element(_nodes[0]),selfTag);html="";var $nodes=[];for(i=0;i<_nodes.length;i++)if(3!==_nodes[i].nodeType){var $n=angular.element(_nodes[i]);if("li"===_nodes[i].tagName.toLowerCase())continue;"ol"===_nodes[i].tagName.toLowerCase()||"ul"===_nodes[i].tagName.toLowerCase()?html+=$n[0].innerHTML:"span"!==_nodes[i].tagName.toLowerCase()||"ol"!==_nodes[i].childNodes[0].tagName.toLowerCase()&&"ul"!==_nodes[i].childNodes[0].tagName.toLowerCase()?html+="<"+taBrowserTag("li")+">"+$n[0].innerHTML+"</"+taBrowserTag("li")+">":html+=$n[0].childNodes[0].innerHTML,$nodes.unshift($n)}$target=angular.element("<"+selfTag+">"+html+"</"+selfTag+">"),$nodes.pop().replaceWith($target),angular.forEach($nodes,function($node){$node.remove()})}return void taSelection.setSelectionToElementEnd($target[0])}}else{if("formatblock"===command.toLowerCase()){for("default"===(optionsTagName=options.toLowerCase().replace(/[<>]/gi,"")).trim()&&(options="<"+(optionsTagName=taDefaultWrap)+">"),$target="li"===tagName?$selected.parent():$selected;!$target[0].tagName||!$target[0].tagName.match(BLOCKELEMENTS)&&!$target.parent().attr("contenteditable");)tagName=(($target=$target.parent())[0].tagName||"").toLowerCase();if(tagName===optionsTagName){_nodes=$target.children();var hasBlock=!1;for(i=0;i<_nodes.length;i++)hasBlock=hasBlock||_nodes[i].tagName.match(BLOCKELEMENTS);$target=hasBlock?($target.after(_nodes),next=$target.next(),$target.remove(),next):(defaultWrapper.append($target[0].childNodes),$target.after(defaultWrapper),$target.remove(),defaultWrapper)}else if($target.parent()[0].tagName.toLowerCase()!==optionsTagName||$target.parent().hasClass("ta-bind"))if(tagName.match(LISTELEMENTS))$target.wrap(options);else{for(0===(_nodes=taSelection.getOnlySelectedElements()).length&&(_nodes=[$target[0]]),i=0;i<_nodes.length;i++)if(3===_nodes[i].nodeType||!_nodes[i].tagName.match(BLOCKELEMENTS))for(;3===_nodes[i].nodeType||!_nodes[i].tagName||!_nodes[i].tagName.match(BLOCKELEMENTS);)_nodes[i]=_nodes[i].parentNode;if(1<(_nodes=_nodes.filter(function(value,index,self){return self.indexOf(value)===index})).length&&(_nodes=_nodes.filter(function(value,index,self){return!("div"===value.nodeName.toLowerCase()&&/^taTextElement/.test(value.id))})),angular.element(_nodes[0]).hasClass("ta-bind"))($target=angular.element(options))[0].innerHTML=_nodes[0].innerHTML,_nodes[0].innerHTML=$target[0].outerHTML;else if("blockquote"===optionsTagName){for(html="",i=0;i<_nodes.length;i++)html+=_nodes[i].outerHTML;for(($target=angular.element(options))[0].innerHTML=html,_nodes[0].parentNode.insertBefore($target[0],_nodes[0]),i=_nodes.length-1;0<=i;i--)_nodes[i].parentNode&&_nodes[i].parentNode.removeChild(_nodes[i])}else if("pre"===optionsTagName&&taSelection.getStateShiftKey()){for(html="",i=0;i<_nodes.length;i++)html+=_nodes[i].outerHTML;for(($target=angular.element(options))[0].innerHTML=html,_nodes[0].parentNode.insertBefore($target[0],_nodes[0]),i=_nodes.length-1;0<=i;i--)_nodes[i].parentNode&&_nodes[i].parentNode.removeChild(_nodes[i])}else for(i=0;i<_nodes.length;i++){var newBlock=turnBlockIntoBlocks(_nodes[i],options);_nodes[i]===$target[0]&&($target=angular.element(newBlock))}}else{var blockElement=$target.parent(),contents=blockElement.contents();for(i=0;i<contents.length;i++)blockElement.parent().hasClass("ta-bind")&&3===contents[i].nodeType&&((defaultWrapper=angular.element("<"+taDefaultWrap+">"))[0].innerHTML=contents[i].outerHTML,contents[i]=defaultWrapper[0]),blockElement.parent()[0].insertBefore(contents[i],blockElement[0]);blockElement.remove()}return taSelection.setSelectionToElementEnd($target[0]),void $target[0].focus()}if("createlink"===command.toLowerCase()){if("a"===tagName)return void(taSelection.getSelectionElement().href=options);var tagBegin='<a href="'+options+'" target="'+(defaultTagAttributes.a.target?defaultTagAttributes.a.target:"")+'">';if(taSelection.getSelection().collapsed)taSelection.insertHtml(tagBegin+options+"</a>",topNode);else if(rangy.getSelection().getRangeAt(0).canSurroundContents()){var node=angular.element(tagBegin+"</a>")[0];rangy.getSelection().getRangeAt(0).surroundContents(node)}return}if("inserthtml"===command.toLowerCase())return void taSelection.insertHtml(options,topNode)}try{$document[0].execCommand(command,showUI,options)}catch(e){}}}}}]).service("taSelection",["$document","taDOM","$log",function($document,taDOM,$log){var bShiftState,_document=$document[0],brException=function(element,offset){return element.tagName&&element.tagName.match(/^br$/i)&&0===offset&&!element.previousSibling?{element:element.parentNode,offset:0}:{element:element,offset:offset}},api={getSelection:function(){var range;try{range=rangy.getSelection().getRangeAt(0)}catch(e){return}var container=range.commonAncestorContainer,selection={start:brException(range.startContainer,range.startOffset),end:brException(range.endContainer,range.endOffset),collapsed:range.collapsed};return 3===container.nodeType&&("div"===container.parentNode.nodeName.toLowerCase()&&/^taTextElement/.test(container.parentNode.id)||(container=container.parentNode)),"div"===container.nodeName.toLowerCase()&&/^taTextElement/.test(container.id)?(selection.start.element=container.childNodes[selection.start.offset],selection.end.element=container.childNodes[selection.end.offset],selection.container=container):container.parentNode===selection.start.element||container.parentNode===selection.end.element?selection.container=container.parentNode:selection.container=container,selection},updateLeftArrowKey:function(){var range=rangy.getSelection().getRangeAt(0);if(range&&range.collapsed){var _nodes=api.getFlattenedDom(range);if(!_nodes.findIndex)return;var nextNodeToRight,nextNodeToLeft,_node=range.startContainer,indexStartContainer=_nodes.findIndex(function(element,index){return element.node===_node||-1!==element.parents.indexOf(_node)});if(_nodes.forEach(function(n,i){n.parents.forEach(function(nn,j){})}),indexStartContainer+1<_nodes.length&&(nextNodeToRight=_nodes[indexStartContainer+1].node),nextNodeToRight&&nextNodeToRight.textContent&&/^\ufeff([^\ufeff]*)$/.exec(nextNodeToRight.textContent))return;if(0<indexStartContainer&&(nextNodeToLeft=_nodes[indexStartContainer-1].node),0===range.startOffset&&nextNodeToLeft&&/^\ufeff([^\ufeff]*)$/.exec(nextNodeToLeft.textContent))return void api.setSelectionToElementEnd(nextNodeToLeft)}},updateRightArrowKey:function(){},getFlattenedDom:function(range){var parent=range.commonAncestorContainer.parentNode;if(!parent)return range.commonAncestorContainer.childNodes;var nodes=Array.prototype.slice.call(parent.childNodes),indexStartContainer=nodes.indexOf(range.startContainer);return indexStartContainer+1<nodes.length&&0<indexStartContainer||parent.parentNode&&(parent=parent.parentNode),nodes=[],function addNodes(_set){_set.node.childNodes.length?Array.prototype.slice.call(_set.node.childNodes).forEach(function(n){var _t=_set.parents.slice();_t.slice(-1)[0]!==_set.node&&_t.push(_set.node),addNodes({parents:_t,node:n})}):nodes.push({parents:_set.parents,node:_set.node})}({parents:[parent],node:parent}),nodes},getOnlySelectedElements:function(){var range=rangy.getSelection().getRangeAt(0),container=range.commonAncestorContainer;return container=3===container.nodeType?container.parentNode:container,range.getNodes([1],function(node){return node.parentNode===container})},getAllSelectedElements:function(){var range=rangy.getSelection().getRangeAt(0),container=range.commonAncestorContainer;container=3===container.nodeType?container.parentNode:container;var selectedNodes=range.getNodes([1],function(node){return node.parentNode===container}),innerHtml=container.innerHTML;if((innerHtml=innerHtml.replace(/<span id=.selectionBoundary[^>]+>\ufeff?<\/span>/gi,""))===range.toHtml()&&("div"!==container.nodeName.toLowerCase()||!/^taTextElement/.test(container.id))){for(var arr=[],i=selectedNodes.length;i--;arr.unshift(selectedNodes[i]));(selectedNodes=arr).push(container)}return selectedNodes},getSelectionElement:function(){return api.getSelection()?api.getSelection().container:void 0},setSelection:function(elStart,elEnd,start,end){var range=rangy.createRange();range.setStart(elStart,start),range.setEnd(elEnd,end),rangy.getSelection().setSingleRange(range)},setSelectionBeforeElement:function(el){var range=rangy.createRange();range.selectNode(el),range.collapse(!0),rangy.getSelection().setSingleRange(range)},setSelectionAfterElement:function(el){var range=rangy.createRange();range.selectNode(el),range.collapse(!1),rangy.getSelection().setSingleRange(range)},setSelectionToElementStart:function(el){var range=rangy.createRange();range.selectNodeContents(el),range.collapse(!0),rangy.getSelection().setSingleRange(range)},setSelectionToElementEnd:function(el){var range=rangy.createRange();range.selectNodeContents(el),range.collapse(!1),el.childNodes&&el.childNodes[el.childNodes.length-1]&&"br"===el.childNodes[el.childNodes.length-1].nodeName&&(range.startOffset=range.endOffset=range.startOffset-1),rangy.getSelection().setSingleRange(range)},setStateShiftKey:function(bS){bShiftState=bS},getStateShiftKey:function(){return bShiftState},insertHtml:function(html,topNode){var parent,secondParent,_childI,nodes,i,lastNode,_tempFrag,element=angular.element("<div>"+html+"</div>"),range=rangy.getSelection().getRangeAt(0),frag=_document.createDocumentFragment(),children=element[0].childNodes,isInline=!0;if(0<children.length){for(nodes=[],_childI=0;_childI<children.length;_childI++){var _cnode=children[_childI];"p"===_cnode.nodeName.toLowerCase()&&""===_cnode.innerHTML.trim()||(isInline=isInline&&!BLOCKELEMENTS.test(_cnode.nodeName),nodes.push(_cnode))}for(var _n=0;_n<nodes.length;_n++)lastNode=frag.appendChild(nodes[_n]);!isInline&&range.collapsed&&/^(|<br(|\/)>)$/i.test(range.startContainer.innerHTML)&&range.selectNode(range.startContainer)}else isInline=!0,lastNode=frag=_document.createTextNode(html);if(isInline)range.deleteContents();else if(range.collapsed&&range.startContainer!==topNode)if(range.startContainer.innerHTML&&range.startContainer.innerHTML.match(/^<[^>]*>$/i))parent=range.startContainer,1===range.startOffset?(range.setStartAfter(parent),range.setEndAfter(parent)):(range.setStartBefore(parent),range.setEndBefore(parent));else{if(3===range.startContainer.nodeType&&range.startContainer.parentNode!==topNode)for(secondParent=(parent=range.startContainer.parentNode).cloneNode(),taDOM.splitNodes(parent.childNodes,parent,secondParent,range.startContainer,range.startOffset);!VALIDELEMENTS.test(parent.nodeName);){angular.element(parent).after(secondParent);var _lastSecondParent=secondParent;secondParent=(parent=parent.parentNode).cloneNode(),taDOM.splitNodes(parent.childNodes,parent,secondParent,_lastSecondParent)}else secondParent=(parent=range.startContainer).cloneNode(),taDOM.splitNodes(parent.childNodes,parent,secondParent,void 0,void 0,range.startOffset);if(angular.element(parent).after(secondParent),range.setStartAfter(parent),range.setEndAfter(parent),/^(|<br(|\/)>)$/i.test(parent.innerHTML.trim())&&(range.setStartBefore(parent),range.setEndBefore(parent),angular.element(parent).remove()),/^(|<br(|\/)>)$/i.test(secondParent.innerHTML.trim())&&angular.element(secondParent).remove(),"li"===parent.nodeName.toLowerCase()){for(_tempFrag=_document.createDocumentFragment(),i=0;i<frag.childNodes.length;i++)element=angular.element("<li>"),taDOM.transferChildNodes(frag.childNodes[i],element[0]),taDOM.transferNodeAttributes(frag.childNodes[i],element[0]),_tempFrag.appendChild(element[0]);frag=_tempFrag,lastNode=lastNode&&(lastNode=frag.childNodes[frag.childNodes.length-1]).childNodes[lastNode.childNodes.length-1]}}else range.deleteContents();range.insertNode(frag),lastNode&&api.setSelectionToElementEnd(lastNode)}};return api}]).service("taDOM",function(){var taDOM={getByAttribute:function(element,attribute){var resultingElements=[],childNodes=element.children();return childNodes.length&&angular.forEach(childNodes,function(child){resultingElements=resultingElements.concat(taDOM.getByAttribute(angular.element(child),attribute))}),void 0!==element.attr(attribute)&&resultingElements.push(element),resultingElements},transferChildNodes:function(source,target){for(target.innerHTML="";0<source.childNodes.length;)target.appendChild(source.childNodes[0]);return target},splitNodes:function(nodes,target1,target2,splitNode,subSplitIndex,splitIndex){if(!splitNode&&isNaN(splitIndex))throw new Error("taDOM.splitNodes requires a splitNode or splitIndex");for(var startNodes=document.createDocumentFragment(),endNodes=document.createDocumentFragment(),index=0;0<nodes.length&&(isNaN(splitIndex)||splitIndex!==index)&&nodes[0]!==splitNode;)startNodes.appendChild(nodes[0]),index++;for(!isNaN(subSplitIndex)&&0<=subSplitIndex&&nodes[0]&&(startNodes.appendChild(document.createTextNode(nodes[0].nodeValue.substring(0,subSplitIndex))),nodes[0].nodeValue=nodes[0].nodeValue.substring(subSplitIndex));0<nodes.length;)endNodes.appendChild(nodes[0]);taDOM.transferChildNodes(startNodes,target1),taDOM.transferChildNodes(endNodes,target2)},transferNodeAttributes:function(source,target){for(var i=0;i<source.attributes.length;i++)target.setAttribute(source.attributes[i].name,source.attributes[i].value);return target}};return taDOM}),angular.module("textAngular.factories",[]).factory("taBrowserTag",[function(){return function(tag){return tag?""===tag?void 0===_browserDetect.ie?"div":_browserDetect.ie<=8?"P":"p":_browserDetect.ie<=8?tag.toUpperCase():tag:_browserDetect.ie<=8?"P":"p"}}]).factory("taApplyCustomRenderers",["taCustomRenderers","taDOM",function(taCustomRenderers,taDOM){return function(val){var element=angular.element("<div></div>");return element[0].innerHTML=val,angular.forEach(taCustomRenderers,function(renderer){var elements=[];renderer.selector&&""!==renderer.selector?elements=element.find(renderer.selector):renderer.customAttribute&&""!==renderer.customAttribute&&(elements=taDOM.getByAttribute(element,renderer.customAttribute)),angular.forEach(elements,function(_element){_element=angular.element(_element),renderer.selector&&""!==renderer.selector&&renderer.customAttribute&&""!==renderer.customAttribute&&void 0===_element.attr(renderer.customAttribute)||renderer.renderLogic(_element)})}),element[0].innerHTML}}]).factory("taFixChrome",function(){return function(html,keepStyles){if(!html||!angular.isString(html)||html.length<=0)return html;for(var match,styleVal,appleSpaceVal,betterSpanMatch=/style\s?=\s?(["'])(?:(?=(\\?))\2.)*?\1/gi,appleConvertedSpaceMatch=/<span class="Apple-converted-space">([^<]+)<\/span>/gi,finalHtml="",lastIndex=0;match=appleConvertedSpaceMatch.exec(html);)appleSpaceVal=(appleSpaceVal=match[1]).replace(/&nbsp;/gi," "),finalHtml+=html.substring(lastIndex,match.index)+appleSpaceVal,lastIndex=match.index+match[0].length;if(lastIndex&&(html=finalHtml+=html.substring(lastIndex),finalHtml="",lastIndex=0),!keepStyles){for(;match=betterSpanMatch.exec(html);)finalHtml+=html.substring(lastIndex,match.index-1),styleVal=match[0],(!(match=/font-family: inherit;|line-height: 1.[0-9]{3,12};|color: inherit; line-height: 1.1;|color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);|background-color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);/gi.exec(styleVal))||8<(styleVal=styleVal.replace(/( |)font-family: inherit;|( |)line-height: 1.[0-9]{3,12};|( |)color: inherit;|( |)color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);|( |)background-color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);/gi,"")).length)&&(finalHtml+=" "+styleVal),lastIndex=betterSpanMatch.lastIndex;finalHtml+=html.substring(lastIndex)}return 0<lastIndex?finalHtml.replace(/<span\s?>(.*?)<\/span>(<br(\/|)>|)/gi,"$1"):html}}).factory("taSanitize",["$sanitize",function($sanitize){for(var convert_infos=[{property:"font-weight",values:["bold"],tag:"b"},{property:"font-style",values:["italic"],tag:"i"}],styleMatch=[],i=0;i<convert_infos.length;i++){for(var _partialStyle="("+convert_infos[i].property+":\\s*(",j=0;j<convert_infos[i].values.length;j++)0<j&&(_partialStyle+="|"),_partialStyle+=convert_infos[i].values[j];_partialStyle+=");)",styleMatch.push(_partialStyle)}var styleRegexString="("+styleMatch.join("|")+")";function wrapNested(html,wrapTag){for(var match,depth=0,lastIndex=0,tagRegex=/<[^>]*>/gi;match=tagRegex.exec(html);)if(lastIndex=match.index,"/"===match[0].substr(1,1)){if(0===depth)break;depth--}else depth++;return wrapTag+html.substring(0,lastIndex)+angular.element(wrapTag)[0].outerHTML.substring(wrapTag.length)+html.substring(lastIndex)}var rsb1=new RegExp(/<span id="selectionBoundary_\d+_\d+" class="rangySelectionBoundary">[^<>]+?<\/span>/gi),rsb2=new RegExp(/<span class="rangySelectionBoundary" id="selectionBoundary_\d+_\d+">[^<>]+?<\/span>/gi),rsb3=new RegExp(/<span id="selectionBoundary_\d+_\d+" class="rangySelectionBoundary">[^<>]+?<\/span>/gi);return function(unsafe,oldsafe,ignore){if(!ignore)try{unsafe=function transformLegacyStyles(html){if(!html||!angular.isString(html)||html.length<=0)return html;for(var i,match,subMatch,styleVal,newTag,newHtml,styleElementMatch=/<([^>\/]+?)style=("([^"]+)"|'([^']+)')([^>]*)>/gi,lastNewTag="",finalHtml="",lastIndex=0;match=styleElementMatch.exec(html);){styleVal=match[3]||match[4];var styleRegex=new RegExp(styleRegexString,"i");if(angular.isString(styleVal)&&styleRegex.test(styleVal)){newTag="";for(var styleRegexExec=new RegExp(styleRegexString,"ig");subMatch=styleRegexExec.exec(styleVal);)for(i=0;i<convert_infos.length;i++)subMatch[2*i+2]&&(newTag+="<"+convert_infos[i].tag+">");newHtml=transformLegacyStyles(html.substring(lastIndex,match.index)),0<lastNewTag.length?finalHtml+=wrapNested(newHtml,lastNewTag):finalHtml+=newHtml,styleVal=styleVal.replace(new RegExp(styleRegexString,"ig"),""),finalHtml+="<"+match[1].trim(),0<styleVal.length&&(finalHtml+=' style="'+styleVal+'"'),finalHtml+=match[5]+">",lastIndex=match.index+match[0].length,lastNewTag=newTag}}return 0<lastNewTag.length?finalHtml+=wrapNested(html.substring(lastIndex),lastNewTag):finalHtml+=html.substring(lastIndex),finalHtml}(unsafe)}catch(e){}if(unsafe=function(html){if(!html||!angular.isString(html)||html.length<=0)return html;for(var match,attrElementMatch=/<([^>\/]+?)align=("([^"]+)"|'([^']+)')([^>]*)>/gi,finalHtml="",lastIndex=0;match=attrElementMatch.exec(html);){finalHtml+=html.substring(lastIndex,match.index),lastIndex=match.index+match[0].length;var newTag="<"+match[1]+match[5];/style=("([^"]+)"|'([^']+)')/gi.test(newTag)?newTag=newTag.replace(/style=("([^"]+)"|'([^']+)')/i,'style="$2$3 text-align:'+(match[3]||match[4])+';"'):newTag+=' style="text-align:'+(match[3]||match[4])+';"',finalHtml+=newTag+=">"}return finalHtml+html.substring(lastIndex)}(unsafe))try{unsafe=(unsafe=(unsafe=(unsafe=unsafe.replace(rsb1,"")).replace(rsb2,"")).replace(rsb1,"")).replace(rsb3,"")}catch(e){}var safe;try{safe=$sanitize(unsafe),ignore&&(safe=unsafe)}catch(e){safe=oldsafe||""}var origTag,_preTags=safe.match(/(<pre[^>]*>.*?<\/pre[^>]*>)/gi),processedSafe=safe.replace(/(&#(9|10);)*/gi,""),re=/<pre[^>]*>.*?<\/pre[^>]*>/gi,index=0,lastIndex=0;for(safe="";null!==(origTag=re.exec(processedSafe))&&index<_preTags.length;)safe+=processedSafe.substring(lastIndex,origTag.index)+_preTags[index],lastIndex=origTag.index+origTag[0].length,index++;return safe+processedSafe.substring(lastIndex)}}]).factory("taToolExecuteAction",["$q","$log",function($q,$log){return function(editor){void 0!==editor&&(this.$editor=function(){return editor});var result,deferred=$q.defer(),promise=deferred.promise,_editor=this.$editor();try{result=this.action(deferred,_editor.startAction()),promise.finally(function(){_editor.endAction.call(_editor)})}catch(exc){$log.error(exc)}!result&&void 0!==result||deferred.resolve()}}]);var textAngularVersion="v1.5.16",_browserDetect={ie:function(){for(var v=3,div=document.createElement("div"),all=div.getElementsByTagName("i");div.innerHTML="\x3c!--[if gt IE "+ ++v+"]><i></i><![endif]--\x3e",all[0];);return 4<v?v:void 0}(),webkit:/AppleWebKit\/([\d.]+)/i.test(navigator.userAgent),isFirefox:-1<navigator.userAgent.toLowerCase().indexOf("firefox")},performance=performance||{};function stripHtmlToText(html){var tmp=document.createElement("DIV");tmp.innerHTML=html;var res=tmp.textContent||tmp.innerText||"";return res.replace("​",""),res=res.trim()}function getDomFromHtml(html){var tmp=document.createElement("DIV");return tmp.innerHTML=html,tmp}performance.now=performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()};var sheet,addCSSRule,removeCSSRule,_addCSSRule,_removeCSSRule,_getRuleIndex,BLOCKELEMENTS=/^(address|article|aside|audio|blockquote|canvas|center|dd|div|dl|fieldset|figcaption|figure|footer|form|h1|h2|h3|h4|h5|h6|header|hgroup|hr|noscript|ol|output|p|pre|section|table|tfoot|ul|video)$/i,LISTELEMENTS=/^(ul|li|ol)$/i,VALIDELEMENTS=/^(#text|span|address|article|aside|audio|blockquote|canvas|center|dd|div|dl|fieldset|figcaption|figure|footer|form|h1|h2|h3|h4|h5|h6|header|hgroup|hr|noscript|ol|output|p|pre|section|table|tfoot|ul|video|li)$/i;if(String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),8<_browserDetect.ie||void 0===_browserDetect.ie){for(var _sheets=document.styleSheets,i=0;i<_sheets.length;i++)if((0===_sheets[i].media.length||_sheets[i].media.mediaText.match(/(all|screen)/gi))&&_sheets[i].href&&_sheets[i].href.match(/textangular\.(min\.|)css/gi)){sheet=_sheets[i];break}sheet=sheet||function(){var style=document.createElement("style");return _browserDetect.webkit&&style.appendChild(document.createTextNode("")),document.getElementsByTagName("head")[0].appendChild(style),style.sheet}(),addCSSRule=function(selector,rules){return _addCSSRule(sheet,selector,rules)},_addCSSRule=function(_sheet,selector,rules){var insertIndex,insertedRule;return _sheet.cssRules?insertIndex=Math.max(_sheet.cssRules.length-1,0):_sheet.rules&&(insertIndex=Math.max(_sheet.rules.length-1,0)),_sheet.insertRule?_sheet.insertRule(selector+"{"+rules+"}",insertIndex):_sheet.addRule(selector,rules,insertIndex),sheet.rules?insertedRule=sheet.rules[insertIndex]:sheet.cssRules&&(insertedRule=sheet.cssRules[insertIndex]),insertedRule},_getRuleIndex=function(rule,rules){var i,ruleIndex;for(i=0;i<rules.length;i++)if(rules[i].cssText===rule.cssText){ruleIndex=i;break}return ruleIndex},removeCSSRule=function(rule){_removeCSSRule(sheet,rule)},_removeCSSRule=function(sheet,rule){var rules=sheet.cssRules||sheet.rules;if(rules&&0!==rules.length){var ruleIndex=_getRuleIndex(rule,rules);sheet.removeRule?sheet.removeRule(ruleIndex):sheet.deleteRule(ruleIndex)}}}var dropFired=!1,textAngular=angular.module("textAngular",["ngSanitize","textAngularSetup","textAngular.factories","textAngular.DOM","textAngular.validators","textAngular.taBind"]);function validElementString(string){try{return 0!==angular.element(string).length}catch(any){return!1}}textAngular.config([function(){angular.forEach(taTools,function(value,key){delete taTools[key]})}]),textAngular.directive("textAngular",["$compile","$timeout","taOptions","taSelection","taExecCommand","textAngularManager","$document","$animate","$log","$q","$parse",function($compile,$timeout,taOptions,taSelection,taExecCommand,textAngularManager,$document,$animate,$log,$q,$parse){return{require:"?ngModel",scope:{customButtons:"=?"},restrict:"EA",priority:2,link:function(scope,element,attrs,ngModel){var customButtonHeader=function(customButtons){for(var customButtonHeader=[],_loop=function(){var button=customButtons[i];textAngularManager.addTool(button.name,{iconclass:button.iconclass,display:button.display,tooltiptext:button.tooltiptext,action:function(){var _this=this,res=button.callback();if(Promise.resolve(res)!==res)return _this.$editor().wrapSelection("insertHTML",res,!0);res.then(function(response){_this.$editor().wrapSelection("insertHTML",response,!0)})}}),customButtonHeader.push(button.name)},i=0;i<customButtons.length;i++)_loop();return customButtonHeader}(scope.customButtons);taOptions.toolbar=taOptions.toolbar.concat([customButtonHeader]);var _keydown,_keyup,_keypress,_mouseup,_focusin,_focusout,_originalContents,_editorFunctions,_taExecCommand,_resizeMouseDown,_updateSelectedStylesTimeout,_resizeTimeout,_serial=attrs.serial?attrs.serial:Math.floor(1e16*Math.random());scope._name=attrs.name?attrs.name:"textAngularEditor"+_serial;var oneEvent=function(_element,event,action){$timeout(function(){_element.one(event,action)},100)};if(_taExecCommand=taExecCommand(attrs.taDefaultWrap),angular.extend(scope,angular.copy(taOptions),{wrapSelection:function(command,opt,isSelectableElementTool){"undo"===command.toLowerCase()?scope["$undoTaBindtaTextElement"+_serial]():"redo"===command.toLowerCase()?scope["$redoTaBindtaTextElement"+_serial]():(_taExecCommand(command,!1,opt,scope.defaultTagAttributes),isSelectableElementTool&&scope["reApplyOnSelectorHandlerstaTextElement"+_serial](),scope.displayElements.text[0].focus())},showHtml:scope.$eval(attrs.taShowHtml)||!1}),attrs.taFocussedClass&&(scope.classes.focussed=attrs.taFocussedClass),attrs.taTextEditorClass&&(scope.classes.textEditor=attrs.taTextEditorClass),attrs.taHtmlEditorClass&&(scope.classes.htmlEditor=attrs.taHtmlEditorClass),attrs.taDefaultTagAttributes)try{angular.extend(scope.defaultTagAttributes,angular.fromJson(attrs.taDefaultTagAttributes))}catch(error){$log.error(error)}attrs.taTextEditorSetup&&(scope.setup.textEditorSetup=scope.$parent.$eval(attrs.taTextEditorSetup)),attrs.taHtmlEditorSetup&&(scope.setup.htmlEditorSetup=scope.$parent.$eval(attrs.taHtmlEditorSetup)),attrs.taFileDrop?scope.fileDropHandler=scope.$parent.$eval(attrs.taFileDrop):scope.fileDropHandler=scope.defaultFileDropHandler,_originalContents=element[0].innerHTML,element[0].innerHTML="",scope.displayElements={forminput:angular.element("<input type='hidden' tabindex='-1' style='display: none;'>"),html:angular.element("<textarea></textarea>"),text:angular.element("<div></div>"),scrollWindow:angular.element("<div class='ta-scroll-window'></div>"),popover:angular.element('<div class="popover fade bottom" style="max-width: none; width: 305px;"></div>'),popoverArrow:angular.element('<div class="arrow"></div>'),popoverContainer:angular.element('<div class="popover-content"></div>'),resize:{overlay:angular.element('<div class="ta-resizer-handle-overlay"></div>'),background:angular.element('<div class="ta-resizer-handle-background"></div>'),anchors:[angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-tl"></div>'),angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-tr"></div>'),angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-bl"></div>'),angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-br"></div>')],info:angular.element('<div class="ta-resizer-handle-info"></div>')}},scope.displayElements.popover.append(scope.displayElements.popoverArrow),scope.displayElements.popover.append(scope.displayElements.popoverContainer),scope.displayElements.scrollWindow.append(scope.displayElements.popover),scope.displayElements.popover.on("mousedown",function(e,eventData){return eventData&&angular.extend(e,eventData),e.preventDefault(),!1}),scope.handlePopoverEvents=function(){"block"===scope.displayElements.popover.css("display")&&(_resizeTimeout&&$timeout.cancel(_resizeTimeout),_resizeTimeout=$timeout(function(){scope.reflowPopover(scope.resizeElement),scope.reflowResizeOverlay(scope.resizeElement)},100))},angular.element(window).on("resize",scope.handlePopoverEvents),angular.element(window).on("scroll",scope.handlePopoverEvents);scope.getScrollTop=function(_el,bAddListener){var scrollTop=_el.scrollTop;return void 0===scrollTop&&(scrollTop=0),bAddListener&&function(node){var cs,_notScrollable={vertical:!1,horizontal:!1};try{if(null===(cs=window.getComputedStyle(node)))return _notScrollable}catch(e){return _notScrollable}var overflowY=cs["overflow-y"],overflowX=cs["overflow-x"];return{vertical:("scroll"===overflowY||"auto"===overflowY)&&node.scrollHeight>node.clientHeight,horizontal:("scroll"===overflowX||"auto"===overflowX)&&node.scrollWidth>node.clientWidth}}(_el).vertical&&(_el.removeEventListener("scroll",scope._scrollListener,!1),_el.addEventListener("scroll",scope._scrollListener,!1)),0!==scrollTop?{node:_el.nodeName,top:scrollTop}:_el.parentNode?scope.getScrollTop(_el.parentNode,bAddListener):{node:"<none>",top:0}},scope.showPopover=function(_el){scope.getScrollTop(scope.displayElements.scrollWindow[0],!0),scope.displayElements.popover.css("display","block"),$timeout(function(){scope.displayElements.resize.overlay.css("display","block")}),scope.resizeElement=_el,scope.reflowPopover(_el),$animate.addClass(scope.displayElements.popover,"in"),oneEvent($document.find("body"),"click keyup",function(){scope.hidePopover()})},scope._scrollListener=function(e,eventData){scope.handlePopoverEvents()},scope.reflowPopover=function(_el){var scrollTop=scope.getScrollTop(scope.displayElements.scrollWindow[0],!1);_el[0].offsetTop-scrollTop.top<51?(scope.displayElements.popover.css("top",_el[0].offsetTop+_el[0].offsetHeight+scope.displayElements.scrollWindow[0].scrollTop+"px"),scope.displayElements.popover.removeClass("top").addClass("bottom")):(scope.displayElements.popover.css("top",_el[0].offsetTop-54+scope.displayElements.scrollWindow[0].scrollTop+"px"),scope.displayElements.popover.removeClass("bottom").addClass("top"));var _maxLeft=scope.displayElements.text[0].offsetWidth-scope.displayElements.popover[0].offsetWidth,_targetLeft=_el[0].offsetLeft+_el[0].offsetWidth/2-scope.displayElements.popover[0].offsetWidth/2,_rleft=Math.max(0,Math.min(_maxLeft,_targetLeft)),_marginLeft=Math.min(_targetLeft,Math.max(0,_targetLeft-_maxLeft))-11;_rleft+=window.scrollX,_marginLeft-=window.scrollX,scope.displayElements.popover.css("left",_rleft+"px"),scope.displayElements.popoverArrow.css("margin-left",_marginLeft+"px")},scope.hidePopover=function(){scope.displayElements.popover.css("display","none"),scope.displayElements.popoverContainer.attr("style",""),scope.displayElements.popoverContainer.attr("class","popover-content"),scope.displayElements.popover.removeClass("in"),scope.displayElements.resize.overlay.css("display","none")},scope.displayElements.resize.overlay.append(scope.displayElements.resize.background),angular.forEach(scope.displayElements.resize.anchors,function(anchor){scope.displayElements.resize.overlay.append(anchor)}),scope.displayElements.resize.overlay.append(scope.displayElements.resize.info),scope.displayElements.scrollWindow.append(scope.displayElements.resize.overlay),scope.displayElements.resize.background.on("click",function(e){scope.displayElements.text[0].focus()}),scope.reflowResizeOverlay=function(_el){_el=angular.element(_el)[0],scope.displayElements.resize.overlay.css({display:"block",left:_el.offsetLeft-5+"px",top:_el.offsetTop-5+"px",width:_el.offsetWidth+10+"px",height:_el.offsetHeight+10+"px"}),scope.displayElements.resize.info.text(_el.offsetWidth+" x "+_el.offsetHeight)},scope.showResizeOverlay=function(_el){var _body=$document.find("body");_resizeMouseDown=function(event){var startPosition={width:parseInt(_el.attr("width")),height:parseInt(_el.attr("height")),x:event.clientX,y:event.clientY};void 0!==startPosition.width&&!isNaN(startPosition.width)||(startPosition.width=_el[0].offsetWidth),void 0!==startPosition.height&&!isNaN(startPosition.height)||(startPosition.height=_el[0].offsetHeight),scope.hidePopover();var ratio=startPosition.height/startPosition.width,mousemove=function(event){var pos={x:Math.max(0,startPosition.width+(event.clientX-startPosition.x)),y:Math.max(0,startPosition.height+(event.clientY-startPosition.y))},bForceAspectRatio=void 0!==attrs.taResizeForceAspectRatio,bFlipKeyBinding=attrs.taResizeMaintainAspectRatio;if(bForceAspectRatio||bFlipKeyBinding&&!event.shiftKey){var newRatio=pos.y/pos.x;pos.x=newRatio<ratio?pos.x:pos.y/ratio,pos.y=newRatio<ratio?pos.x*ratio:pos.y}var el=angular.element(_el);function roundedMaxVal(val){return Math.round(Math.max(0,val))}el.css("height",roundedMaxVal(pos.y)+"px"),el.css("width",roundedMaxVal(pos.x)+"px"),scope.reflowResizeOverlay(_el)};_body.on("mousemove",mousemove),oneEvent(_body,"mouseup",function(event){event.preventDefault(),event.stopPropagation(),_body.off("mousemove",mousemove),scope.$apply(function(){scope.hidePopover(),scope.updateTaBindtaTextElement()},100)}),event.stopPropagation(),event.preventDefault()},scope.displayElements.resize.anchors[3].off("mousedown"),scope.displayElements.resize.anchors[3].on("mousedown",_resizeMouseDown),scope.reflowResizeOverlay(_el),oneEvent(_body,"click",function(){scope.hideResizeOverlay()})},scope.hideResizeOverlay=function(){scope.displayElements.resize.anchors[3].off("mousedown",_resizeMouseDown),scope.displayElements.resize.overlay.css("display","none")},scope.setup.htmlEditorSetup(scope.displayElements.html),scope.setup.textEditorSetup(scope.displayElements.text),scope.displayElements.html.attr({id:"taHtmlElement"+_serial,"ng-show":"showHtml","ta-bind":"ta-bind","ng-model":"html","ng-model-options":element.attr("ng-model-options")}),scope.displayElements.text.attr({id:"taTextElement"+_serial,contentEditable:"true","ta-bind":"ta-bind","ng-model":"html","ng-model-options":element.attr("ng-model-options")}),scope.displayElements.scrollWindow.attr({"ng-hide":"showHtml"}),attrs.taDefaultWrap&&scope.displayElements.text.attr("ta-default-wrap",attrs.taDefaultWrap),attrs.taUnsafeSanitizer&&(scope.displayElements.text.attr("ta-unsafe-sanitizer",attrs.taUnsafeSanitizer),scope.displayElements.html.attr("ta-unsafe-sanitizer",attrs.taUnsafeSanitizer)),attrs.taKeepStyles&&(scope.displayElements.text.attr("ta-keep-styles",attrs.taKeepStyles),scope.displayElements.html.attr("ta-keep-styles",attrs.taKeepStyles)),scope.displayElements.scrollWindow.append(scope.displayElements.text),element.append(scope.displayElements.scrollWindow),element.append(scope.displayElements.html),scope.displayElements.forminput.attr("name",scope._name),element.append(scope.displayElements.forminput),attrs.tabindex&&(element.removeAttr("tabindex"),scope.displayElements.text.attr("tabindex",attrs.tabindex),scope.displayElements.html.attr("tabindex",attrs.tabindex)),attrs.placeholder&&(scope.displayElements.text.attr("placeholder",attrs.placeholder),scope.displayElements.html.attr("placeholder",attrs.placeholder)),attrs.taDisabled&&(scope.displayElements.text.attr("ta-readonly","disabled"),scope.displayElements.html.attr("ta-readonly","disabled"),scope.disabled=scope.$parent.$eval(attrs.taDisabled),scope.$parent.$watch(attrs.taDisabled,function(newVal){scope.disabled=newVal,scope.disabled?element.addClass(scope.classes.disabled):element.removeClass(scope.classes.disabled)})),attrs.taPaste&&(scope._pasteHandler=function(_html){return $parse(attrs.taPaste)(scope.$parent,{$html:_html})},scope.displayElements.text.attr("ta-paste","_pasteHandler($html)")),$compile(scope.displayElements.scrollWindow)(scope),$compile(scope.displayElements.html)(scope),scope.updateTaBindtaTextElement=scope["updateTaBindtaTextElement"+_serial],scope.updateTaBindtaHtmlElement=scope["updateTaBindtaHtmlElement"+_serial],element.addClass("ta-root"),scope.displayElements.scrollWindow.addClass("ta-text ta-editor "+scope.classes.textEditor),scope.displayElements.html.addClass("ta-html ta-editor "+scope.classes.htmlEditor);var testAndSet=function(choice,beforeState){beforeState!==$document[0].queryCommandState(choice)&&$document[0].execCommand(choice,!1,null)},_savedSelection=scope._actionRunning=!1;if(scope.startAction=function(){var _beforeStateBold,_beforeStateItalic,_beforeStateUnderline,_beforeStateStrikethough;return scope._actionRunning=!0,_beforeStateBold=$document[0].queryCommandState("bold"),_beforeStateItalic=$document[0].queryCommandState("italic"),_beforeStateUnderline=$document[0].queryCommandState("underline"),_beforeStateStrikethough=$document[0].queryCommandState("strikeThrough"),_savedSelection=rangy.saveSelection(),testAndSet("bold",_beforeStateBold),testAndSet("italic",_beforeStateItalic),testAndSet("underline",_beforeStateUnderline),testAndSet("strikeThrough",_beforeStateStrikethough),function(){_savedSelection&&rangy.restoreSelection(_savedSelection)}},scope.endAction=function(){scope._actionRunning=!1,_savedSelection&&(scope.showHtml?scope.displayElements.html[0].focus():scope.displayElements.text[0].focus(),rangy.removeMarkers(_savedSelection)),_savedSelection=!1,scope.updateSelectedStyles(),scope.showHtml||scope["updateTaBindtaTextElement"+_serial]()},_focusin=function(){scope.focussed=!0,element.addClass(scope.classes.focussed),_editorFunctions.focus(),element.triggerHandler("focus"),scope.updateSelectedStyles&&!scope._bUpdateSelectedStyles&&$timeout(function(){scope.updateSelectedStyles()},0)},scope.displayElements.html.on("focus",_focusin),scope.displayElements.text.on("focus",_focusin),_focusout=function(e){return scope._actionRunning||$document[0].activeElement===scope.displayElements.html[0]||$document[0].activeElement===scope.displayElements.text[0]||(element.removeClass(scope.classes.focussed),_editorFunctions.unfocus(),$timeout(function(){scope._bUpdateSelectedStyles=!1,element.triggerHandler("blur"),scope.focussed=!1},0)),e.preventDefault(),!1},scope.displayElements.html.on("blur",_focusout),scope.displayElements.text.on("blur",_focusout),scope.displayElements.text.on("paste",function(event){element.triggerHandler("paste",event)}),scope.queryFormatBlockState=function(command){return!scope.showHtml&&command.toLowerCase()===$document[0].queryCommandValue("formatBlock").toLowerCase()},scope.queryCommandState=function(command){return scope.showHtml?"":$document[0].queryCommandState(command)},scope.switchView=function(){scope.showHtml=!scope.showHtml,$animate.enabled(!1,scope.displayElements.html),$animate.enabled(!1,scope.displayElements.text),scope.showHtml?$timeout(function(){return $animate.enabled(!0,scope.displayElements.html),$animate.enabled(!0,scope.displayElements.text),scope.displayElements.html[0].focus()},100):$timeout(function(){return $animate.enabled(!0,scope.displayElements.html),$animate.enabled(!0,scope.displayElements.text),scope.displayElements.text[0].focus()},100)},attrs.ngModel){var _firstRun=!0;ngModel.$render=function(){if(_firstRun){_firstRun=!1;var _initialValue=scope.$parent.$eval(attrs.ngModel);null==_initialValue&&_originalContents&&""!==_originalContents&&ngModel.$setViewValue(_originalContents)}scope.displayElements.forminput.val(ngModel.$viewValue),scope.html=ngModel.$viewValue||""},element.attr("required")&&(ngModel.$validators.required=function(modelValue,viewValue){var value=modelValue||viewValue;return!(!value||""===value.trim())})}else scope.displayElements.forminput.val(_originalContents),scope.html=_originalContents;if(scope.$watch("html",function(newValue,oldValue){newValue!==oldValue&&(attrs.ngModel&&ngModel.$viewValue!==newValue&&ngModel.$setViewValue(newValue),scope.displayElements.forminput.val(newValue))}),attrs.taTargetToolbars)_editorFunctions=textAngularManager.registerEditor(scope._name,scope,attrs.taTargetToolbars.split(","));else{var _toolbar=angular.element('<div text-angular-toolbar name="textAngularToolbar'+_serial+'">');attrs.taToolbar&&_toolbar.attr("ta-toolbar",attrs.taToolbar),attrs.taToolbarClass&&_toolbar.attr("ta-toolbar-class",attrs.taToolbarClass),attrs.taToolbarGroupClass&&_toolbar.attr("ta-toolbar-group-class",attrs.taToolbarGroupClass),attrs.taToolbarButtonClass&&_toolbar.attr("ta-toolbar-button-class",attrs.taToolbarButtonClass),attrs.taToolbarActiveButtonClass&&_toolbar.attr("ta-toolbar-active-button-class",attrs.taToolbarActiveButtonClass),attrs.taFocussedClass&&_toolbar.attr("ta-focussed-class",attrs.taFocussedClass),element.prepend(_toolbar),$compile(_toolbar)(scope.$parent),_editorFunctions=textAngularManager.registerEditor(scope._name,scope,["textAngularToolbar"+_serial])}scope.$on("$destroy",function(){textAngularManager.unregisterEditor(scope._name),angular.element(window).off("blur"),angular.element(window).off("resize",scope.handlePopoverEvents),angular.element(window).off("scroll",scope.handlePopoverEvents)}),scope.$on("ta-element-select",function(event,element){_editorFunctions.triggerElementSelect(event,element)&&scope["reApplyOnSelectorHandlerstaTextElement"+_serial]()}),scope.$on("ta-drop-event",function(event,element,dropEvent,dataTransfer){dataTransfer&&dataTransfer.files&&0<dataTransfer.files.length?(scope.displayElements.text[0].focus(),taSelection.setSelectionToElementEnd(dropEvent.target),angular.forEach(dataTransfer.files,function(file){try{$q.when(scope.fileDropHandler(file,scope.wrapSelection)||scope.fileDropHandler!==scope.defaultFileDropHandler&&$q.when(scope.defaultFileDropHandler(file,scope.wrapSelection))).then(function(){scope["updateTaBindtaTextElement"+_serial]()})}catch(error){$log.error(error)}}),dropEvent.preventDefault(),dropEvent.stopPropagation()):$timeout(function(){scope["updateTaBindtaTextElement"+_serial]()},0)}),scope._bUpdateSelectedStyles=!1,angular.element(window).on("blur",function(){scope._bUpdateSelectedStyles=!1,scope.focussed=!1}),scope.updateSelectedStyles=function(){var _selection;_updateSelectedStylesTimeout&&$timeout.cancel(_updateSelectedStylesTimeout),void 0!==(_selection=taSelection.getSelectionElement())&&_selection.parentNode!==scope.displayElements.text[0]?_editorFunctions.updateSelectedStyles(angular.element(_selection)):_editorFunctions.updateSelectedStyles(),scope._bUpdateSelectedStyles&&(_updateSelectedStylesTimeout=$timeout(scope.updateSelectedStyles,200))},_keydown=function(){scope.focussed?scope._bUpdateSelectedStyles||(scope._bUpdateSelectedStyles=!0,scope.$apply(function(){scope.updateSelectedStyles()})):scope._bUpdateSelectedStyles=!1},scope.displayElements.html.on("keydown",_keydown),scope.displayElements.text.on("keydown",_keydown),_keyup=function(){scope._bUpdateSelectedStyles=!1},scope.displayElements.html.on("keyup",_keyup),scope.displayElements.text.on("keyup",_keyup),_keypress=function(event,eventData){if(taSelection.getSelection){var _selection=taSelection.getSelection();taSelection.getSelectionElement()&&"a"===taSelection.getSelectionElement().nodeName.toLowerCase()&&(3===_selection.start.element.nodeType&&_selection.start.element.textContent.length===_selection.end.offset&&taSelection.setSelectionAfterElement(taSelection.getSelectionElement()),3===_selection.start.element.nodeType&&0===_selection.start.offset&&taSelection.setSelectionBeforeElement(taSelection.getSelectionElement()))}eventData&&angular.extend(event,eventData),scope.$apply(function(){if(_editorFunctions.sendKeyCommand(event))return scope._bUpdateSelectedStyles||scope.updateSelectedStyles(),event.preventDefault(),!1})},scope.displayElements.html.on("keypress",_keypress),scope.displayElements.text.on("keypress",_keypress),_mouseup=function(){scope._bUpdateSelectedStyles=!1,$timeout(function(){scope.updateSelectedStyles()},0)},scope.displayElements.html.on("mouseup",_mouseup),scope.displayElements.text.on("mouseup",_mouseup)}}}]),textAngular.service("textAngularManager",["taToolExecuteAction","taTools","taRegisterTool","$interval","$rootScope","$log",function(taToolExecuteAction,taTools,taRegisterTool,$interval,$rootScope,$log){var triggerIntervalTimer,toolbars={},editors={},timeRecentModification=0,updateStyles=function(selectedElement){angular.forEach(editors,function(editor){editor.editorFunctions.updateSelectedStyles(selectedElement)})};$rootScope.$on("destroy",function(){triggerIntervalTimer&&($interval.cancel(triggerIntervalTimer),triggerIntervalTimer=void 0)});var touchModification=function(){50<Math.abs(Date.now()-timeRecentModification)&&(timeRecentModification=Date.now(),triggerIntervalTimer=$interval(function(){updateStyles(),triggerIntervalTimer=void 0},50,1))};return{registerEditor:function(editorName,editorScope,targetToolbars){if(!editorName||""===editorName)throw"textAngular Error: An editor requires a name";if(!editorScope)throw"textAngular Error: An editor requires a scope";if(editors[editorName])throw'textAngular Error: An Editor with name "'+editorName+'" already exists';return editors[editorName]={scope:editorScope,toolbars:targetToolbars,toolbarScopes:[],_registerToolbarScope:function(toolbarScope){0<=this.toolbars.indexOf(toolbarScope.name)&&this.toolbarScopes.push(toolbarScope)},editorFunctions:{disable:function(){angular.forEach(editors[editorName].toolbarScopes,function(toolbarScope){toolbarScope.disabled=!0})},enable:function(){angular.forEach(editors[editorName].toolbarScopes,function(toolbarScope){toolbarScope.disabled=!1})},focus:function(){angular.forEach(editors[editorName].toolbarScopes,function(toolbarScope){toolbarScope._parent=editorScope,toolbarScope.disabled=!1,toolbarScope.focussed=!0}),editorScope.focussed=!0},unfocus:function(){angular.forEach(editors[editorName].toolbarScopes,function(toolbarScope){toolbarScope.disabled=!0,toolbarScope.focussed=!1}),editorScope.focussed=!1},updateSelectedStyles:function(selectedElement){angular.forEach(editors[editorName].toolbarScopes,function(toolbarScope){angular.forEach(toolbarScope.tools,function(toolScope){toolScope.activeState&&(toolbarScope._parent=editorScope,toolScope.active=toolScope.activeState(selectedElement))})})},sendKeyCommand:function(event){var result=!1;return(event.ctrlKey||event.metaKey||event.specialKey)&&angular.forEach(taTools,function(tool,name){if(tool.commandKeyCode&&(tool.commandKeyCode===event.which||tool.commandKeyCode===event.specialKey))for(var _t=0;_t<editors[editorName].toolbarScopes.length;_t++)if(void 0!==editors[editorName].toolbarScopes[_t].tools[name]){taToolExecuteAction.call(editors[editorName].toolbarScopes[_t].tools[name],editorScope),result=!0;break}}),result},triggerElementSelect:function(event,element){var elementHasAttrs=function(_element,attrs){for(var result=!0,i=0;i<attrs.length;i++)result=result&&_element.attr(attrs[i]);return result},workerTools=[],unfilteredTools={},result=!1;element=angular.element(element);var onlyWithAttrsFilter=!1;if(angular.forEach(taTools,function(tool,name){tool.onElementSelect&&tool.onElementSelect.element&&tool.onElementSelect.element.toLowerCase()===element[0].tagName.toLowerCase()&&(!tool.onElementSelect.filter||tool.onElementSelect.filter(element))&&(onlyWithAttrsFilter=onlyWithAttrsFilter||angular.isArray(tool.onElementSelect.onlyWithAttrs)&&elementHasAttrs(element,tool.onElementSelect.onlyWithAttrs),tool.onElementSelect.onlyWithAttrs&&!elementHasAttrs(element,tool.onElementSelect.onlyWithAttrs)||(unfilteredTools[name]=tool))}),onlyWithAttrsFilter?(angular.forEach(unfilteredTools,function(tool,name){tool.onElementSelect.onlyWithAttrs&&elementHasAttrs(element,tool.onElementSelect.onlyWithAttrs)&&workerTools.push({name:name,tool:tool})}),workerTools.sort(function(a,b){return b.tool.onElementSelect.onlyWithAttrs.length-a.tool.onElementSelect.onlyWithAttrs.length})):angular.forEach(unfilteredTools,function(tool,name){workerTools.push({name:name,tool:tool})}),0<workerTools.length)for(var _i=0;_i<workerTools.length;_i++){for(var tool=workerTools[_i].tool,name=workerTools[_i].name,_t=0;_t<editors[editorName].toolbarScopes.length;_t++)if(void 0!==editors[editorName].toolbarScopes[_t].tools[name]){tool.onElementSelect.action.call(editors[editorName].toolbarScopes[_t].tools[name],event,element,editorScope),result=!0;break}if(result)break}return result}}},angular.forEach(targetToolbars,function(_name){toolbars[_name]&&editors[editorName].toolbarScopes.push(toolbars[_name])}),touchModification(),editors[editorName].editorFunctions},retrieveEditor:function(name){return editors[name]},unregisterEditor:function(name){delete editors[name],touchModification()},registerToolbar:function(toolbarScope){if(!toolbarScope)throw"textAngular Error: A toolbar requires a scope";if(!toolbarScope.name||""===toolbarScope.name)throw"textAngular Error: A toolbar requires a name";if(toolbars[toolbarScope.name])throw'textAngular Error: A toolbar with name "'+toolbarScope.name+'" already exists';toolbars[toolbarScope.name]=toolbarScope,angular.forEach(editors,function(_editor){_editor._registerToolbarScope(toolbarScope)}),touchModification()},retrieveToolbar:function(name){return toolbars[name]},retrieveToolbarsViaEditor:function(name){var result=[],_this=this;return angular.forEach(this.retrieveEditor(name).toolbars,function(name){result.push(_this.retrieveToolbar(name))}),result},unregisterToolbar:function(name){delete toolbars[name],touchModification()},updateToolsDisplay:function(newTaTools){var _this=this;angular.forEach(newTaTools,function(_newTool,key){_this.updateToolDisplay(key,_newTool)})},resetToolsDisplay:function(){var _this=this;angular.forEach(taTools,function(_newTool,key){_this.resetToolDisplay(key)}),touchModification()},updateToolDisplay:function(toolKey,_newTool){var _this=this;angular.forEach(toolbars,function(toolbarScope,toolbarKey){_this.updateToolbarToolDisplay(toolbarKey,toolKey,_newTool)}),touchModification()},resetToolDisplay:function(toolKey){var _this=this;angular.forEach(toolbars,function(toolbarScope,toolbarKey){_this.resetToolbarToolDisplay(toolbarKey,toolKey)}),touchModification()},updateToolbarToolDisplay:function(toolbarKey,toolKey,_newTool){if(!toolbars[toolbarKey])throw'textAngular Error: No Toolbar with name "'+toolbarKey+'" exists';toolbars[toolbarKey].updateToolDisplay(toolKey,_newTool)},resetToolbarToolDisplay:function(toolbarKey,toolKey){if(!toolbars[toolbarKey])throw'textAngular Error: No Toolbar with name "'+toolbarKey+'" exists';toolbars[toolbarKey].updateToolDisplay(toolKey,taTools[toolKey],!0)},removeTool:function(toolKey){delete taTools[toolKey],angular.forEach(toolbars,function(toolbarScope){delete toolbarScope.tools[toolKey];for(var i=0;i<toolbarScope.toolbar.length;i++){for(var toolbarIndex,j=0;j<toolbarScope.toolbar[i].length;j++){if(toolbarScope.toolbar[i][j]===toolKey){toolbarIndex={group:i,index:j};break}if(void 0!==toolbarIndex)break}void 0!==toolbarIndex&&(toolbarScope.toolbar[toolbarIndex.group].slice(toolbarIndex.index,1),toolbarScope._$element.children().eq(toolbarIndex.group).children().eq(toolbarIndex.index).remove())}}),touchModification()},addTool:function(toolKey,toolDefinition,group,index){taRegisterTool(toolKey,toolDefinition),angular.forEach(toolbars,function(toolbarScope){toolbarScope.addTool(toolKey,toolDefinition,group,index)}),touchModification()},addToolToToolbar:function(toolKey,toolDefinition,toolbarKey,group,index){taRegisterTool(toolKey,toolDefinition),toolbars[toolbarKey].addTool(toolKey,toolDefinition,group,index),touchModification()},refreshEditor:function(name){if(!editors[name])throw'textAngular Error: No Editor with name "'+name+'" exists';editors[name].scope.updateTaBindtaTextElement(),editors[name].scope.$$phase||editors[name].scope.$digest(),touchModification()},sendKeyCommand:function(scope,event){var _editor=editors[scope._name];if(_editor&&_editor.editorFunctions.sendKeyCommand(event))return scope._bUpdateSelectedStyles||scope.updateSelectedStyles(),event.preventDefault(),!1},updateStyles:updateStyles,getVersion:function(){return textAngularVersion},getToolbarScopes:function(){var tmp=[];return angular.forEach(editors,function(_editor){tmp=tmp.concat(_editor.toolbarScopes)}),tmp}}}]),textAngular.directive("textAngularToolbar",["$compile","textAngularManager","taOptions","taTools","taToolExecuteAction","$window",function($compile,textAngularManager,taOptions,taTools,taToolExecuteAction,$window){return{scope:{name:"@"},restrict:"EA",link:function(scope,element,attrs){if(!scope.name||""===scope.name)throw"textAngular Error: A toolbar requires a name";angular.extend(scope,angular.copy(taOptions)),attrs.taToolbar&&(scope.toolbar=scope.$parent.$eval(attrs.taToolbar)),attrs.taToolbarClass&&(scope.classes.toolbar=attrs.taToolbarClass),attrs.taToolbarGroupClass&&(scope.classes.toolbarGroup=attrs.taToolbarGroupClass),attrs.taToolbarButtonClass&&(scope.classes.toolbarButton=attrs.taToolbarButtonClass),attrs.taToolbarActiveButtonClass&&(scope.classes.toolbarButtonActive=attrs.taToolbarActiveButtonClass),attrs.taFocussedClass&&(scope.classes.focussed=attrs.taFocussedClass),scope.disabled=!0,scope.focussed=!1,(scope._$element=element)[0].innerHTML="",element.addClass("ta-toolbar "+scope.classes.toolbar),scope.$watch("focussed",function(){scope.focussed?element.addClass(scope.classes.focussed):element.removeClass(scope.classes.focussed)});var setupToolElement=function(toolDefinition,toolScope){var toolElement;if(toolElement=toolDefinition&&toolDefinition.display?angular.element(toolDefinition.display):angular.element("<button type='button'>"),toolDefinition&&toolDefinition.class?toolElement.addClass(toolDefinition.class):toolElement.addClass(scope.classes.toolbarButton),toolElement.attr("name",toolScope.name),toolElement.attr("ta-button","ta-button"),toolElement.attr("ng-disabled","isDisabled()"),toolElement.attr("tabindex","-1"),toolElement.attr("ng-click","executeAction()"),toolElement.attr("ng-class","displayActiveToolClass(active)"),toolDefinition&&toolDefinition.tooltiptext&&toolElement.attr("title",toolDefinition.tooltiptext),toolDefinition&&!toolDefinition.display&&!toolScope._display&&(toolElement[0].innerHTML="",toolDefinition.buttontext&&(toolElement[0].innerHTML=toolDefinition.buttontext),toolDefinition.iconclass)){var icon=angular.element("<i>"),content=toolElement[0].innerHTML;icon.addClass(toolDefinition.iconclass),toolElement[0].innerHTML="",toolElement.append(icon),content&&""!==content&&toolElement.append("&nbsp;"+content)}return toolScope._lastToolDefinition=angular.copy(toolDefinition),$compile(toolElement)(toolScope)};scope.tools={},scope._parent={disabled:!0,showHtml:!1,queryFormatBlockState:function(){return!1},queryCommandState:function(){return!1}};var defaultChildScope={$window:$window,$editor:function(){return scope._parent},isDisabled:function(){return("html"!==this.name||!scope._parent.startAction)&&("function"!=typeof this.$eval("disabled")&&this.$eval("disabled")||this.$eval("disabled()")||"html"!==this.name&&this.$editor().showHtml||this.$parent.disabled||this.$editor().disabled)},displayActiveToolClass:function(active){return active?scope.classes.toolbarButtonActive:""},executeAction:taToolExecuteAction};angular.forEach(scope.toolbar,function(group){var groupElement=angular.element("<div>");groupElement.addClass(scope.classes.toolbarGroup),angular.forEach(group,function(tool){scope.tools[tool]=angular.extend(scope.$new(!0),taTools[tool],defaultChildScope,{name:tool}),scope.tools[tool].$element=setupToolElement(taTools[tool],scope.tools[tool]),groupElement.append(scope.tools[tool].$element)}),element.append(groupElement)}),scope.updateToolDisplay=function(key,_newTool,forceNew){var toolInstance=scope.tools[key];if(toolInstance){if(toolInstance._lastToolDefinition&&!forceNew&&(_newTool=angular.extend({},toolInstance._lastToolDefinition,_newTool)),null===_newTool.buttontext&&null===_newTool.iconclass&&null===_newTool.display)throw'textAngular Error: Tool Definition for updating "'+key+'" does not have a valid display/iconclass/buttontext value';null===_newTool.buttontext&&delete _newTool.buttontext,null===_newTool.iconclass&&delete _newTool.iconclass,null===_newTool.display&&delete _newTool.display;var toolElement=setupToolElement(_newTool,toolInstance);toolInstance.$element.replaceWith(toolElement),toolInstance.$element=toolElement}},scope.addTool=function(key,_newTool,groupIndex,index){var group;scope.tools[key]=angular.extend(scope.$new(!0),taTools[key],defaultChildScope,{name:key}),scope.tools[key].$element=setupToolElement(taTools[key],scope.tools[key]),void 0===groupIndex&&(groupIndex=scope.toolbar.length-1),group=angular.element(element.children()[groupIndex]),void 0===index?(group.append(scope.tools[key].$element),scope.toolbar[groupIndex][scope.toolbar[groupIndex].length-1]=key):(group.children().eq(index).after(scope.tools[key].$element),scope.toolbar[groupIndex][index]=key)},textAngularManager.registerToolbar(scope),scope.$on("$destroy",function(){textAngularManager.unregisterToolbar(scope.name)})}}}]),textAngular.directive("textAngularVersion",["textAngularManager",function(textAngularManager){var version=textAngularManager.getVersion();return{restrict:"EA",link:function(scope,element){element.html(version)}}}]),angular.module("textAngular.taBind",["textAngular.factories","textAngular.DOM"]).service("_taBlankTest",[function(){return function(_blankVal){return!_blankVal||""===stripHtmlToText(_blankVal)&&!/<img[^>]+>/.test(_blankVal)}}]).directive("taButton",[function(){return{link:function(scope,element){element.attr("unselectable","on"),element.on("mousedown",function(e,eventData){return eventData&&angular.extend(e,eventData),e.preventDefault(),!1})}}}]).directive("taBind",["taSanitize","$timeout","$document","taFixChrome","taBrowserTag","taSelection","taSelectableElements","taApplyCustomRenderers","taOptions","_taBlankTest","$parse","taDOM","textAngularManager",function(taSanitize,$timeout,$document,taFixChrome,taBrowserTag,taSelection,taSelectableElements,taApplyCustomRenderers,taOptions,_taBlankTest,$parse,taDOM,textAngularManager){return{priority:2,require:["ngModel","?ngModelOptions"],link:function(scope,element,attrs,controller){var _lastKey,_pasteHandler,_defaultVal,ngModel=controller[0],ngModelOptions=controller[1]||{},_isContentEditable=void 0!==element.attr("contenteditable")&&element.attr("contenteditable"),_isInputFriendly=_isContentEditable||"textarea"===element[0].tagName.toLowerCase()||"input"===element[0].tagName.toLowerCase(),_isReadonly=!1,_focussed=!1,_skipRender=!1,_disableSanitizer=attrs.taUnsafeSanitizer||taOptions.disableSanitizer,_keepStyles=attrs.taKeepStyles||taOptions.keepStyles,BLOCKED_KEYS=/^(9|19|20|27|33|34|35|36|37|38|39|40|45|112|113|114|115|116|117|118|119|120|121|122|123|144|145)$/i,UNDO_TRIGGER_KEYS=/^(8|13|32|46|59|61|107|109|173|186|187|188|189|190|191|192|219|220|221|222)$/i,_keyMappings=[{specialKey:"UndoKey",forbiddenModifiers:12,mustHaveModifiers:[3],keyCode:90},{specialKey:"RedoKey",forbiddenModifiers:4,mustHaveModifiers:[3,8],keyCode:90},{specialKey:"RedoKey",forbiddenModifiers:12,mustHaveModifiers:[3],keyCode:89},{specialKey:"TabKey",forbiddenModifiers:15,mustHaveModifiers:[],keyCode:9},{specialKey:"ShiftTabKey",forbiddenModifiers:7,mustHaveModifiers:[8],keyCode:9}];void 0===attrs.taDefaultWrap&&(attrs.taDefaultWrap="p"),""===attrs.taDefaultWrap?(_defaultVal="",void 0===_browserDetect.ie||11<=_browserDetect.ie||_browserDetect.ie):(_defaultVal=void 0===_browserDetect.ie||11<=_browserDetect.ie?"br"===attrs.taDefaultWrap.toLowerCase()?"<BR><BR>":"<"+attrs.taDefaultWrap+"><br></"+attrs.taDefaultWrap+">":_browserDetect.ie<=8?"<"+attrs.taDefaultWrap.toUpperCase()+"></"+attrs.taDefaultWrap.toUpperCase()+">":"<"+attrs.taDefaultWrap+"></"+attrs.taDefaultWrap+">",void 0===_browserDetect.ie||11<=_browserDetect.ie?"br"===attrs.taDefaultWrap.toLowerCase()||(attrs.taDefaultWrap,attrs.taDefaultWrap):_browserDetect.ie<=8?(attrs.taDefaultWrap.toUpperCase(),attrs.taDefaultWrap.toUpperCase()):(attrs.taDefaultWrap,attrs.taDefaultWrap)),ngModelOptions.$options||(ngModelOptions.$options={});var _undoKeyupTimeout,_ensureContentWrapped=function(value){if(_taBlankTest(value))return value;var domTest=angular.element("<div>"+value+"</div>");if(0===domTest.children().length)value="<"+attrs.taDefaultWrap+">"+value+"</"+attrs.taDefaultWrap+">";else{var i,_children=domTest[0].childNodes,_foundBlockElement=!1;for(i=0;i<_children.length&&!(_foundBlockElement=_children[i].nodeName.toLowerCase().match(BLOCKELEMENTS));i++);if(_foundBlockElement)for(value="",i=0;i<_children.length;i++){var node=_children[i],nodeName=node.nodeName.toLowerCase();if("#comment"===nodeName)value+="\x3c!--"+node.nodeValue+"--\x3e";else if("#text"===nodeName){var text=node.textContent;text.trim()?value+="<"+attrs.taDefaultWrap+">"+text+"</"+attrs.taDefaultWrap+">":value+=text}else if(nodeName.match(BLOCKELEMENTS))value+=node.outerHTML;else{var _subVal=node.outerHTML||node.nodeValue;""!==_subVal.trim()?value+="<"+attrs.taDefaultWrap+">"+_subVal+"</"+attrs.taDefaultWrap+">":value+=_subVal}}else value="<"+attrs.taDefaultWrap+">"+value+"</"+attrs.taDefaultWrap+">"}return value};attrs.taPaste&&(_pasteHandler=$parse(attrs.taPaste)),element.addClass("ta-bind"),scope["$undoManager"+(attrs.id||"")]=ngModel.$undoManager={_stack:[],_index:0,_max:1e3,push:function(value){return null==value||void 0!==this.current()&&null!==this.current()&&value===this.current()||(this._index<this._stack.length-1&&(this._stack=this._stack.slice(0,this._index+1)),this._stack.push(value),_undoKeyupTimeout&&$timeout.cancel(_undoKeyupTimeout),this._stack.length>this._max&&this._stack.shift(),this._index=this._stack.length-1),value},undo:function(){return this.setToIndex(this._index-1)},redo:function(){return this.setToIndex(this._index+1)},setToIndex:function(index){if(!(index<0||index>this._stack.length-1))return this._index=index,this.current()},current:function(){return this._stack[this._index]}};var _redoUndoTimeout,_compileHtml=function(){if(_isContentEditable)return element[0].innerHTML;if(_isInputFriendly)return element.val();throw"textAngular Error: attempting to update non-editable taBind"},selectorClickHandler=function(event){return scope.$emit("ta-element-select",this),event.preventDefault(),!1},_reApplyOnSelectorHandlers=scope["reApplyOnSelectorHandlers"+(attrs.id||"")]=function(){_isReadonly||angular.forEach(taSelectableElements,function(selector){element.find(selector).off("click",selectorClickHandler).on("click",selectorClickHandler)})},_setViewValue=function(_val,triggerUndo,skipRender){_skipRender=skipRender||!1,null==triggerUndo&&(triggerUndo=_isContentEditable),null==_val&&(_val=_compileHtml()),_taBlankTest(_val)?(""!==ngModel.$viewValue&&ngModel.$setViewValue(""),triggerUndo&&""!==ngModel.$undoManager.current()&&ngModel.$undoManager.push("")):(_reApplyOnSelectorHandlers(),ngModel.$viewValue!==_val&&(ngModel.$setViewValue(_val),triggerUndo&&ngModel.$undoManager.push(_val))),ngModel.$render()},_setInnerHTML=function(newval){element[0].innerHTML=newval},_undo=scope["$undoTaBind"+(attrs.id||"")]=function(){if(!_isReadonly&&_isContentEditable){var content=ngModel.$undoManager.undo();null!=content&&(_setInnerHTML(content),_setViewValue(content,!1),_redoUndoTimeout&&$timeout.cancel(_redoUndoTimeout),_redoUndoTimeout=$timeout(function(){element[0].focus(),taSelection.setSelectionToElementEnd(element[0])},1))}},_redo=scope["$redoTaBind"+(attrs.id||"")]=function(){if(!_isReadonly&&_isContentEditable){var content=ngModel.$undoManager.redo();null!=content&&(_setInnerHTML(content),_setViewValue(content,!1),_redoUndoTimeout&&$timeout.cancel(_redoUndoTimeout),_redoUndoTimeout=$timeout(function(){element[0].focus(),taSelection.setSelectionToElementEnd(element[0])},1))}};scope["updateTaBind"+(attrs.id||"")]=function(){_isReadonly||_setViewValue(void 0,void 0,!0)};var _sanitize=function(unsafe){return ngModel.$oldViewValue=taSanitize(taFixChrome(unsafe,_keepStyles),ngModel.$oldViewValue,_disableSanitizer)};if(element.attr("required")&&(ngModel.$validators.required=function(modelValue,viewValue){return!_taBlankTest(modelValue||viewValue)}),ngModel.$parsers.push(_sanitize),ngModel.$parsers.unshift(_ensureContentWrapped),ngModel.$formatters.push(_sanitize),ngModel.$formatters.unshift(_ensureContentWrapped),ngModel.$formatters.unshift(function(value){return ngModel.$undoManager.push(value||"")}),_isInputFriendly)if(scope.events={},_isContentEditable){var _keyupTimeout,_inputTimeout,_processingPaste=!1,processpaste=function(text){var _isOneNote=void 0!==text&&text.match(/content=["']*OneNote.File/i);if(text&&text.trim().length){if(text.match(/class=["']*Mso(Normal|List)/i)||text.match(/content=["']*Word.Document/i)||text.match(/content=["']*OneNote.File/i)){var textFragment=text.match(/<!--StartFragment-->([\s\S]*?)<!--EndFragment-->/i);textFragment=(textFragment=textFragment?textFragment[1]:text).replace(/<o:p>[\s\S]*?<\/o:p>/gi,"").replace(/class=(["']|)MsoNormal(["']|)/gi,"");var dom=angular.element("<div>"+textFragment+"</div>"),targetDom=angular.element("<div></div>"),_list={element:null,lastIndent:[],lastLi:null,isUl:!1};_list.lastIndent.peek=function(){var n=this.length;if(0<n)return this[n-1]};for(var _resetList=function(isUl){_list.isUl=isUl,_list.element=angular.element(isUl?"<ul>":"<ol>"),_list.lastIndent=[],_list.lastIndent.peek=function(){var n=this.length;if(0<n)return this[n-1]},_list.lastLevelMatch=null},i=0;i<=dom[0].childNodes.length;i++)if(dom[0].childNodes[i]&&"#text"!==dom[0].childNodes[i].nodeName){var tagName=dom[0].childNodes[i].tagName.toLowerCase();if("p"===tagName||"ul"===tagName||"h1"===tagName||"h2"===tagName||"h3"===tagName||"h4"===tagName||"h5"===tagName||"h6"===tagName||"table"===tagName){var el=angular.element(dom[0].childNodes[i]),_listMatch=(el.attr("class")||"").match(/MsoList(Bullet|Number|Paragraph)(CxSp(First|Middle|Last)|)/i);if(_listMatch){if(el[0].childNodes.length<2||el[0].childNodes[1].childNodes.length<1)continue;var isUl="bullet"===_listMatch[1].toLowerCase()||"number"!==_listMatch[1].toLowerCase()&&!(/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(el[0].childNodes[1].innerHTML)||/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(el[0].childNodes[1].childNodes[0].innerHTML)),_indentMatch=(el.attr("style")||"").match(/margin-left:([\-\.0-9]*)/i),indent=parseFloat(_indentMatch?_indentMatch[1]:0),_levelMatch=(el.attr("style")||"").match(/mso-list:l([0-9]+) level([0-9]+) lfo[0-9+]($|;)/i);if(_levelMatch&&_levelMatch[2]&&(indent=parseInt(_levelMatch[2])),_levelMatch&&(!_list.lastLevelMatch||_levelMatch[1]!==_list.lastLevelMatch[1])||!_listMatch[3]||"first"===_listMatch[3].toLowerCase()||null===_list.lastIndent.peek()||_list.isUl!==isUl&&_list.lastIndent.peek()===indent)_resetList(isUl),targetDom.append(_list.element);else if(null!=_list.lastIndent.peek()&&_list.lastIndent.peek()<indent)_list.element=angular.element(isUl?"<ul>":"<ol>"),_list.lastLi.append(_list.element);else if(null!=_list.lastIndent.peek()&&_list.lastIndent.peek()>indent){for(;null!=_list.lastIndent.peek()&&_list.lastIndent.peek()>indent;)if("li"!==_list.element.parent()[0].tagName.toLowerCase()){if(!/[uo]l/i.test(_list.element.parent()[0].tagName.toLowerCase()))break;_list.element=_list.element.parent(),_list.lastIndent.pop()}else _list.element=_list.element.parent();_list.isUl="ul"===_list.element[0].tagName.toLowerCase(),isUl!==_list.isUl&&(_resetList(isUl),targetDom.append(_list.element))}_list.lastLevelMatch=_levelMatch,indent!==_list.lastIndent.peek()&&_list.lastIndent.push(indent),_list.lastLi=angular.element("<li>"),_list.element.append(_list.lastLi),_list.lastLi.html(el.html().replace(/<!(--|)\[if !supportLists\](--|)>[\s\S]*?<!(--|)\[endif\](--|)>/gi,"")),el.remove()}else _resetList(!1),targetDom.append(el)}}var _unwrapElement=function(node){for(var _n=(node=angular.element(node))[0].childNodes.length-1;0<=_n;_n--)node.after(node[0].childNodes[_n]);node.remove()};angular.forEach(targetDom.find("span"),function(node){node.removeAttribute("lang"),node.attributes.length<=0&&_unwrapElement(node)}),angular.forEach(targetDom.find("font"),_unwrapElement),text=targetDom.html(),_isOneNote&&(text=targetDom.html()||dom.html()),text=text.replace(/\n/g," ")}else{if((text=text.replace(/<(|\/)meta[^>]*?>/gi,"")).match(/<[^>]*?(ta-bind)[^>]*?>/)){if(text.match(/<[^>]*?(text-angular)[^>]*?>/)){var _el=angular.element("<div>"+text+"</div>");_el.find("textarea").remove();for(var _b=0;_b<binds.length;_b++){for(var _target=binds[_b][0].parentNode.parentNode,_c=0;_c<binds[_b][0].childNodes.length;_c++)_target.parentNode.insertBefore(binds[_b][0].childNodes[_c],_target);_target.parentNode.removeChild(_target)}text=_el.html().replace('<br class="Apple-interchange-newline">',"")}}else text.match(/^<span/)&&(text.match(/<span class=(\"Apple-converted-space\"|\'Apple-converted-space\')>.<\/span>/gi)||(text=text.replace(/<(|\/)span[^>]*?>/gi,"")));text=text.replace(/<br class="Apple-interchange-newline"[^>]*?>/gi,"").replace(/<span class="Apple-converted-space">( |&nbsp;)<\/span>/gi,"&nbsp;")}/<li(\s.*)?>/i.test(text)&&!1===/(<ul(\s.*)?>|<ol(\s.*)?>).*<li(\s.*)?>/i.test(text)&&(text=text.replace(/<li(\s.*)?>.*<\/li(\s.*)?>/i,"<ul>$&</ul>")),text=text.replace(/^[ |\u00A0]+/gm,function(match){for(var result="",i=0;i<match.length;i++)result+="&nbsp;";return result}).replace(/\n|\r\n|\r/g,"<br />").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;"),_pasteHandler&&(text=_pasteHandler(scope,{$html:text})||text),text=text.replace(/<span style=("|')([^<]*?)vertical-align\s*:\s*super;?([^>]*?)("|')>([^<]+?)<\/span>/g,"<sup style='$2$3'>$5</sup>"),text=taSanitize(text,"",_disableSanitizer),taSelection.insertHtml(text,element[0]),$timeout(function(){ngModel.$setViewValue(_compileHtml()),_processingPaste=!1,element.removeClass("processing-paste")},0)}else _processingPaste=!1,element.removeClass("processing-paste")};if(element.on("paste",scope.events.paste=function(e,eventData){if(eventData&&angular.extend(e,eventData),_isReadonly||_processingPaste)return e.stopPropagation(),e.preventDefault(),!1;var pastedContent;_processingPaste=!0,element.addClass("processing-paste");var clipboardData=(e.originalEvent||e).clipboardData;if(!clipboardData&&window.clipboardData&&window.clipboardData.getData)return pastedContent=window.clipboardData.getData("Text"),processpaste(pastedContent),e.stopPropagation(),e.preventDefault(),!1;if(clipboardData&&clipboardData.getData&&0<clipboardData.types.length){for(var _types="",_t=0;_t<clipboardData.types.length;_t++)_types+=" "+clipboardData.types[_t];return/text\/html/i.test(_types)?pastedContent=clipboardData.getData("text/html"):/text\/plain/i.test(_types)&&(pastedContent=clipboardData.getData("text/plain")),processpaste(pastedContent),e.stopPropagation(),e.preventDefault(),!1}var _savedSelection=rangy.saveSelection(),_tempDiv=angular.element('<div class="ta-hidden-input" contenteditable="true"></div>');$document.find("body").append(_tempDiv),_tempDiv[0].focus(),$timeout(function(){rangy.restoreSelection(_savedSelection),processpaste(_tempDiv[0].innerHTML),element[0].focus(),_tempDiv.remove()},0)}),element.on("cut",scope.events.cut=function(e){_isReadonly?e.preventDefault():$timeout(function(){ngModel.$setViewValue(_compileHtml())},0)}),element.on("keydown",scope.events.keydown=function(event,eventData){var userSpecialKey;if(eventData&&angular.extend(event,eventData),16===event.keyCode?taSelection.setStateShiftKey(!0):taSelection.setStateShiftKey(!1),event.specialKey=function(event){var specialKey;return _keyMappings.forEach(function(map){if(map.keyCode===event.keyCode){var netModifiers=(event.metaKey?2:0)+(event.ctrlKey?1:0)+(event.shiftKey?8:0)+(event.altKey?4:0);if(map.forbiddenModifiers&netModifiers)return;map.mustHaveModifiers.every(function(modifier){return netModifiers&modifier})&&(specialKey=map.specialKey)}}),specialKey}(event),taOptions.keyMappings.forEach(function(mapping){event.specialKey===mapping.commandKeyCode&&(event.specialKey=void 0),mapping.testForKey(event)&&(userSpecialKey=mapping.commandKeyCode),"UndoKey"!==mapping.commandKeyCode&&"RedoKey"!==mapping.commandKeyCode||mapping.enablePropagation||event.preventDefault()}),void 0!==userSpecialKey&&(event.specialKey=userSpecialKey),void 0===event.specialKey||"UndoKey"===event.specialKey&&"RedoKey"===event.specialKey||(event.preventDefault(),textAngularManager.sendKeyCommand(scope,event)),!(_isReadonly||("UndoKey"===event.specialKey&&(_undo(),event.preventDefault()),"RedoKey"===event.specialKey&&(_redo(),event.preventDefault()),13!==event.keyCode||event.shiftKey||event.ctrlKey||event.metaKey||event.altKey))){var $selection,selection=taSelection.getSelectionElement();if(!selection.nodeName.match(VALIDELEMENTS))return;var _new=angular.element(_defaultVal);if(function(a,obj){for(var i=0;i<a.length;i++)if(a[i]===obj)return!0;return!1}(["blockquote","ul","ol"],selection.parentNode.tagName.toLowerCase())){if(/^<br(|\/)>$/i.test(selection.innerHTML.trim())&&!selection.nextSibling){var _parent=($selection=angular.element(selection)).parent();_parent.after(_new),$selection.remove(),0===_parent.children().length&&_parent.remove(),taSelection.setSelectionToElementStart(_new[0]),event.preventDefault()}/^<[^>]+><br(|\/)><\/[^>]+>$/i.test(selection.innerHTML.trim())&&(($selection=angular.element(selection)).after(_new),$selection.remove(),taSelection.setSelectionToElementStart(_new[0]),event.preventDefault())}}}),element.on("keyup",scope.events.keyup=function(event,eventData){if(eventData&&angular.extend(event,eventData),taSelection.setStateShiftKey(!1),9!==event.keyCode){if(37!==event.keyCode||event.shiftKey||taSelection.updateLeftArrowKey(element),39!==event.keyCode||event.shiftKey||taSelection.updateRightArrowKey(element),_undoKeyupTimeout&&$timeout.cancel(_undoKeyupTimeout),!(_isReadonly||BLOCKED_KEYS.test(event.keyCode)||13===event.keyCode&&(event.ctrlKey||event.metaKey||event.altKey))){if(""!==_defaultVal&&"<BR><BR>"!==_defaultVal&&13===event.keyCode&&!event.ctrlKey&&!event.metaKey&&!event.altKey){for(var selection=taSelection.getSelectionElement();!selection.nodeName.match(VALIDELEMENTS)&&selection!==element[0];)selection=selection.parentNode;if(event.shiftKey){var tagName=selection.tagName.toLowerCase();if((tagName===attrs.taDefaultWrap||"li"===tagName||"pre"===tagName||"div"===tagName)&&!/.+<br><br>/.test(selection.innerHTML.trim())){var ps=selection.previousSibling;ps&&(ps.innerHTML=ps.innerHTML+"<br><br>",angular.element(selection).remove(),taSelection.setSelectionToElementEnd(ps))}}else if(selection.tagName.toLowerCase()!==attrs.taDefaultWrap&&"li"!==selection.nodeName.toLowerCase()&&(""===selection.innerHTML.trim()||"<br>"===selection.innerHTML.trim())){var _new=angular.element(_defaultVal);angular.element(selection).replaceWith(_new),taSelection.setSelectionToElementStart(_new[0])}}var val=_compileHtml();""===_defaultVal||""!==val.trim()&&"<br>"!==val.trim()?"<"!==val.substring(0,1)&&attrs.taDefaultWrap:(_setInnerHTML(_defaultVal),taSelection.setSelectionToElementStart(element.children()[0]));var triggerUndo=_lastKey!==event.keyCode&&UNDO_TRIGGER_KEYS.test(event.keyCode);_keyupTimeout&&$timeout.cancel(_keyupTimeout),_keyupTimeout=$timeout(function(){_setViewValue(val,triggerUndo,!0)},ngModelOptions.$options.debounce||400),triggerUndo||(_undoKeyupTimeout=$timeout(function(){ngModel.$undoManager.push(val)},250)),_lastKey=event.keyCode}}else taSelection.getSelection().start.element===element[0]&&element.children().length&&taSelection.setSelectionToElementStart(element.children()[0])}),element.on("input",function(){_compileHtml()!==ngModel.$viewValue&&(_inputTimeout&&$timeout.cancel(_inputTimeout),_inputTimeout=$timeout(function(){var _savedSelection=rangy.saveSelection(),_val=_compileHtml();_val!==ngModel.$viewValue&&_setViewValue(_val,!0),0!==ngModel.$viewValue.length&&rangy.restoreSelection(_savedSelection)},1e3))}),element.on("blur",scope.events.blur=function(){_focussed=!1,_isReadonly?(_skipRender=!0,ngModel.$render()):_setViewValue(void 0,void 0,!0)}),attrs.placeholder&&(8<_browserDetect.ie||void 0===_browserDetect.ie)){var rule;if(!attrs.id)throw"textAngular Error: An unique ID is required for placeholders to work";rule=addCSSRule("#"+attrs.id+".placeholder-text:before",'content: "'+attrs.placeholder+'"'),scope.$on("$destroy",function(){removeCSSRule(rule)})}element.on("focus",scope.events.focus=function(){_focussed=!0,element.removeClass("placeholder-text"),_reApplyOnSelectorHandlers()}),element.on("mouseup",scope.events.mouseup=function(){var _selection=taSelection.getSelection();_selection&&_selection.start.element===element[0]&&element.children().length&&taSelection.setSelectionToElementStart(element.children()[0])}),element.on("mousedown",scope.events.mousedown=function(event,eventData){eventData&&angular.extend(event,eventData),event.stopPropagation()})}else{element.on("change blur",scope.events.change=scope.events.blur=function(){_isReadonly||ngModel.$setViewValue(_compileHtml())}),element.on("keydown",scope.events.keydown=function(event,eventData){if(eventData&&angular.extend(event,eventData),9===event.keyCode){var start=this.selectionStart,end=this.selectionEnd,value=element.val();if(event.shiftKey){var _linebreak=value.lastIndexOf("\n",start),_tab=value.lastIndexOf("\t",start);-1!==_tab&&_linebreak<=_tab&&(element.val(value.substring(0,_tab)+value.substring(_tab+1)),this.selectionStart=this.selectionEnd=start-1)}else element.val(value.substring(0,start)+"\t"+value.substring(end)),this.selectionStart=this.selectionEnd=start+1;event.preventDefault()}});var _repeat=function(string,n){for(var result="",_n=0;_n<n;_n++)result+=string;return result},forEach=function(array,callback,scope){for(var i=0;i<array.length;i++)callback.call(scope,i,array[i])};ngModel.$formatters.unshift(function(htmlValue){var _nodes=angular.element("<div>"+htmlValue+"</div>")[0].childNodes;return 0<_nodes.length&&(htmlValue="",forEach(_nodes,function(index,node){var nodeName=node.nodeName.toLowerCase();"#comment"!==nodeName?"#text"!==nodeName?node.outerHTML&&(0<htmlValue.length&&(htmlValue+="\n"),htmlValue+="ul"===nodeName||"ol"===nodeName?""+function recursiveListFormat(listNode,tablevel){var _html="",_subnodes=listNode.childNodes;return _html+=_repeat("\t",++tablevel-1)+listNode.outerHTML.substring(0,4),forEach(_subnodes,function(index,node){var nodeName=node.nodeName.toLowerCase();"#comment"!==nodeName?"#text"!==nodeName?node.outerHTML&&(_html+="ul"===nodeName||"ol"===nodeName?"\n"+recursiveListFormat(node,tablevel):"\n"+_repeat("\t",tablevel)+node.outerHTML):_html+=node.textContent:_html+="\x3c!--"+node.nodeValue+"--\x3e"}),_html+="\n"+_repeat("\t",tablevel-1)+listNode.outerHTML.substring(listNode.outerHTML.lastIndexOf("<"))}(node,0):""+node.outerHTML):htmlValue+=node.textContent:htmlValue+="\x3c!--"+node.nodeValue+"--\x3e"})),htmlValue})}var _renderTimeout,fileDropHandler=function(event,eventData){var dataTransfer;eventData&&angular.extend(event,eventData),dropFired||_isReadonly||(dropFired=!0,dataTransfer=event.originalEvent?event.originalEvent.dataTransfer:event.dataTransfer,scope.$emit("ta-drop-event",this,event,dataTransfer),$timeout(function(){_setViewValue(void 0,void 0,!(dropFired=!1))},100))},_renderInProgress=!1;ngModel.$render=function(){if(!_renderInProgress){_renderInProgress=!0;var val=ngModel.$viewValue||"";_skipRender||(_isContentEditable&&_focussed&&(element.removeClass("placeholder-text"),_renderTimeout&&$timeout.cancel(_renderTimeout),_renderTimeout=$timeout(function(){_focussed||(element[0].focus(),taSelection.setSelectionToElementEnd(element.children()[element.children().length-1])),_renderTimeout=void 0},1)),_isContentEditable?(attrs.placeholder,_setInnerHTML(""===val?_defaultVal:val),_isReadonly?element.off("drop",fileDropHandler):(_reApplyOnSelectorHandlers(),element.on("drop",fileDropHandler))):"textarea"!==element[0].tagName.toLowerCase()&&"input"!==element[0].tagName.toLowerCase()?_setInnerHTML(taApplyCustomRenderers(val)):element.val(val)),_isContentEditable&&attrs.placeholder&&(""!==val||_focussed?element.removeClass("placeholder-text"):element.addClass("placeholder-text")),_renderInProgress=_skipRender=!1}},attrs.taReadonly&&((_isReadonly=scope.$eval(attrs.taReadonly))?(element.addClass("ta-readonly"),"textarea"!==element[0].tagName.toLowerCase()&&"input"!==element[0].tagName.toLowerCase()||element.attr("disabled","disabled"),void 0!==element.attr("contenteditable")&&element.attr("contenteditable")&&element.removeAttr("contenteditable")):(element.removeClass("ta-readonly"),"textarea"===element[0].tagName.toLowerCase()||"input"===element[0].tagName.toLowerCase()?element.removeAttr("disabled"):_isContentEditable&&element.attr("contenteditable","true")),scope.$watch(attrs.taReadonly,function(newVal,oldVal){oldVal!==newVal&&(newVal?(element.addClass("ta-readonly"),"textarea"!==element[0].tagName.toLowerCase()&&"input"!==element[0].tagName.toLowerCase()||element.attr("disabled","disabled"),void 0!==element.attr("contenteditable")&&element.attr("contenteditable")&&element.removeAttr("contenteditable"),angular.forEach(taSelectableElements,function(selector){element.find(selector).on("click",selectorClickHandler)}),element.off("drop",fileDropHandler)):(element.removeClass("ta-readonly"),"textarea"===element[0].tagName.toLowerCase()||"input"===element[0].tagName.toLowerCase()?element.removeAttr("disabled"):_isContentEditable&&element.attr("contenteditable","true"),angular.forEach(taSelectableElements,function(selector){element.find(selector).off("click",selectorClickHandler)}),element.on("drop",fileDropHandler)),_isReadonly=newVal)})),_isContentEditable&&!_isReadonly&&(angular.forEach(taSelectableElements,function(selector){element.find(selector).on("click",selectorClickHandler)}),element.on("drop",fileDropHandler))}}}]),function(angular){var $sanitizeMinErr=angular.$$minErr("$sanitize");var START_TAG_REGEXP=/^<((?:[a-zA-Z])[\w:-]*)((?:\s+[\w:-]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)\s*(>?)/,END_TAG_REGEXP=/^<\/\s*([\w:-]+)[^>]*>/,ATTR_REGEXP=/([\w:-]+)(?:\s*=\s*(?:(?:"((?:[^"])*)")|(?:'((?:[^'])*)')|([^>\s]+)))?/g,BEGIN_TAG_REGEXP=/^</,BEGING_END_TAGE_REGEXP=/^<\//,COMMENT_REGEXP=/<!--(.*?)-->/g,SINGLE_COMMENT_REGEXP=/(^<!--.*?-->)/,DOCTYPE_REGEXP=/<!DOCTYPE([^>]*?)>/i,CDATA_REGEXP=/<!\[CDATA\[(.*?)]]>/g,SURROGATE_PAIR_REGEXP=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,NON_ALPHANUMERIC_REGEXP=/([^\#-~| |!])/g,WHITE_SPACE_REGEXP=/^(\s+)/,voidElements=makeMap("area,br,col,hr,img,wbr,input"),optionalEndTagBlockElements=makeMap("colgroup,dd,dt,li,p,tbody,td,tfoot,th,thead,tr"),optionalEndTagInlineElements=makeMap("rp,rt"),optionalEndTagElements=angular.extend({},optionalEndTagInlineElements,optionalEndTagBlockElements),blockElements=angular.extend({},optionalEndTagBlockElements,makeMap("address,article,aside,blockquote,caption,center,del,dir,div,dl,figure,figcaption,footer,h1,h2,h3,h4,h5,h6,header,hgroup,hr,ins,map,menu,nav,ol,pre,script,section,table,ul")),inlineElements=angular.extend({},optionalEndTagInlineElements,makeMap("a,abbr,acronym,b,bdi,bdo,big,br,cite,code,del,dfn,em,font,i,img,ins,kbd,label,map,mark,q,ruby,rp,rt,s,samp,small,span,strike,strong,sub,sup,time,tt,u,var")),svgElements=makeMap("animate,animateColor,animateMotion,animateTransform,circle,defs,desc,ellipse,font-face,font-face-name,font-face-src,g,glyph,hkern,image,linearGradient,line,marker,metadata,missing-glyph,mpath,path,polygon,polyline,radialGradient,rect,set,stop,svg,switch,text,title,tspan,use"),specialElements=makeMap("script,style"),validElements=angular.extend({},voidElements,blockElements,inlineElements,optionalEndTagElements,svgElements),uriAttrs=makeMap("background,cite,href,longdesc,src,usemap,xlink:href"),htmlAttrs=makeMap("abbr,align,alt,axis,bgcolor,border,cellpadding,cellspacing,class,clear,color,cols,colspan,compact,coords,dir,face,headers,height,hreflang,hspace,id,ismap,lang,language,nohref,nowrap,rel,rev,rows,rowspan,rules,scope,scrolling,shape,size,span,start,summary,target,title,type,valign,value,vspace,width"),svgAttrs=makeMap("accent-height,accumulate,additive,alphabetic,arabic-form,ascent,attributeName,attributeType,baseProfile,bbox,begin,by,calcMode,cap-height,class,color,color-rendering,content,cx,cy,d,dx,dy,descent,display,dur,end,fill,fill-rule,font-family,font-size,font-stretch,font-style,font-variant,font-weight,from,fx,fy,g1,g2,glyph-name,gradientUnits,hanging,height,horiz-adv-x,horiz-origin-x,ideographic,k,keyPoints,keySplines,keyTimes,lang,marker-end,marker-mid,marker-start,markerHeight,markerUnits,markerWidth,mathematical,max,min,offset,opacity,orient,origin,overline-position,overline-thickness,panose-1,path,pathLength,points,preserveAspectRatio,r,refX,refY,repeatCount,repeatDur,requiredExtensions,requiredFeatures,restart,rotate,rx,ry,slope,stemh,stemv,stop-color,stop-opacity,strikethrough-position,strikethrough-thickness,stroke,stroke-dasharray,stroke-dashoffset,stroke-linecap,stroke-linejoin,stroke-miterlimit,stroke-opacity,stroke-width,systemLanguage,target,text-anchor,to,transform,type,u1,u2,underline-position,underline-thickness,unicode,unicode-range,units-per-em,values,version,viewBox,visibility,width,widths,x,x-height,x1,x2,xlink:actuate,xlink:arcrole,xlink:role,xlink:show,xlink:title,xlink:type,xml:base,xml:lang,xml:space,xmlns,xmlns:xlink,y,y1,y2,zoomAndPan"),validAttrs=angular.extend({},uriAttrs,svgAttrs,htmlAttrs);function makeMap(str){var i,obj={},items=str.split(",");for(i=0;i<items.length;i++)obj[items[i]]=!0;return obj}var hiddenPre=document.createElement("pre"),spaceRe=/^(\s*)([\s\S]*?)(\s*)$/;function decodeEntities(value){if(!value)return"";var parts=spaceRe.exec(value),spaceBefore=parts[1],spaceAfter=parts[3],content=parts[2];return content&&(hiddenPre.innerHTML=content.replace(/</g,"&lt;"),content="textContent"in hiddenPre?hiddenPre.textContent:hiddenPre.innerText),spaceBefore+content+spaceAfter}function encodeEntities(value){return value.replace(/&/g,"&amp;").replace(SURROGATE_PAIR_REGEXP,function(value){return"&#"+(1024*(value.charCodeAt(0)-55296)+(value.charCodeAt(1)-56320)+65536)+";"}).replace(NON_ALPHANUMERIC_REGEXP,function(value){var c=value.charCodeAt(0);return c<=159||173==c||1536<=c&&c<=1540||1807==c||6068==c||6069==c||8204<=c&&c<=8207||8232<=c&&c<=8239||8288<=c&&c<=8303||65279==c||65520<=c&&c<=65535?"&#"+c+";":value}).replace(/</g,"&lt;").replace(/>/g,"&gt;")}var trim=String.prototype.trim?function(value){return angular.isString(value)?value.trim():value}:function(value){return angular.isString(value)?value.replace(/^\s\s*/,"").replace(/\s\s*$/,""):value};function htmlSanitizeWriter(buf,uriValidator){var ignore=!1,out=angular.bind(buf,buf.push);return{start:function(tag,attrs,unary){tag=angular.lowercase(tag),!ignore&&specialElements[tag]&&(ignore=tag),ignore||!0!==validElements[tag]||(out("<"),out(tag),angular.forEach(attrs,function(value,key){var result,styleArray,lkey=angular.lowercase(key),isImage="img"===tag&&"src"===lkey||"background"===lkey;("style"===lkey&&""!==(result="",styleArray=value.split(";"),angular.forEach(styleArray,function(value){var v=value.split(":");if(2==v.length){var key=trim(angular.lowercase(v[0]));value=trim(angular.lowercase(v[1])),(("color"===key||"background-color"===key)&&(value.match(/^rgb\([0-9%,\. ]*\)$/i)||value.match(/^rgba\([0-9%,\. ]*\)$/i)||value.match(/^hsl\([0-9%,\. ]*\)$/i)||value.match(/^hsla\([0-9%,\. ]*\)$/i)||value.match(/^#[0-9a-f]{3,6}$/i)||value.match(/^[a-z]*$/i))||"text-align"===key&&("left"===value||"right"===value||"center"===value||"justify"===value)||"text-decoration"===key&&("underline"===value||"line-through"===value)||"font-weight"===key&&"bold"===value||"font-style"===key&&"italic"===value||"float"===key&&("left"===value||"right"===value||"none"===value)||"vertical-align"===key&&("baseline"===value||"sub"===value||"super"===value||"test-top"===value||"text-bottom"===value||"middle"===value||"top"===value||"bottom"===value||value.match(/[0-9]*(px|em)/)||value.match(/[0-9]+?%/))||"font-size"===key&&("xx-small"===value||"x-small"===value||"small"===value||"medium"===value||"large"===value||"x-large"===value||"xx-large"===value||"larger"===value||"smaller"===value||value.match(/[0-9]*\.?[0-9]*(px|em|rem|mm|q|cm|in|pt|pc|%)/))||("width"===key||"height"===key)&&value.match(/[0-9\.]*(px|em|rem|%)/)||"direction"===key&&value.match(/^ltr|rtl|initial|inherit$/))&&(result+=key+": "+value+";")}}),value=result)||function(tag,attrs,lkey,value){return!("img"!==tag||!attrs["ta-insert-video"]||"ta-insert-video"!==lkey&&"allowfullscreen"!==lkey&&"frameborder"!==lkey&&("contenteditable"!==lkey||"false"!==value))}(tag,attrs,lkey,value)||!0===validAttrs[lkey]&&(!0!==uriAttrs[lkey]||uriValidator(value,isImage)))&&(out(" "),out(key),out('="'),out(encodeEntities(value)),out('"'))}),out(unary?"/>":">"))},comment:function(com){out(com)},whitespace:function(ws){out(encodeEntities(ws))},end:function(tag){tag=angular.lowercase(tag),ignore||!0!==validElements[tag]||(out("</"),out(tag),out(">")),tag==ignore&&(ignore=!1)},chars:function(_chars){ignore||out(encodeEntities(_chars))}}}angular.module("ngSanitize",[]).provider("$sanitize",function(){this.$get=["$$sanitizeUri",function($$sanitizeUri){return function(html){void 0!==arguments[1]&&(arguments[1].version="taSanitize");var buf=[];return function(html,handler){"string"!=typeof html&&(html=null==html?"":""+html);var index,chars,match,text,stack=[],last=html;stack.last=function(){return stack[stack.length-1]};for(;html;){if(chars=!(text=""),stack.last()&&specialElements[stack.last()])html=html.replace(new RegExp("([^]*)<\\s*\\/\\s*"+stack.last()+"[^>]*>","i"),function(all,text){return text=text.replace(COMMENT_REGEXP,"$1").replace(CDATA_REGEXP,"$1"),handler.chars&&handler.chars(decodeEntities(text)),""}),parseEndTag(0,stack.last());else{if(WHITE_SPACE_REGEXP.test(html)){if(match=html.match(WHITE_SPACE_REGEXP)){match[0];handler.whitespace&&handler.whitespace(match[0]),html=html.replace(match[0],""),chars=!1}}else SINGLE_COMMENT_REGEXP.test(html)?(match=html.match(SINGLE_COMMENT_REGEXP))&&(handler.comment&&handler.comment(match[1]),html=html.replace(match[0],""),chars=!1):DOCTYPE_REGEXP.test(html)?(match=html.match(DOCTYPE_REGEXP))&&(html=html.replace(match[0],""),chars=!1):BEGING_END_TAGE_REGEXP.test(html)?(match=html.match(END_TAG_REGEXP))&&(html=html.substring(match[0].length),match[0].replace(END_TAG_REGEXP,parseEndTag),chars=!1):BEGIN_TAG_REGEXP.test(html)&&((match=html.match(START_TAG_REGEXP))?(match[4]&&(html=html.substring(match[0].length),match[0].replace(START_TAG_REGEXP,parseStartTag)),chars=!1):(text+="<",html=html.substring(1)));chars&&(index=html.indexOf("<"),text+=index<0?html:html.substring(0,index),html=index<0?"":html.substring(index),handler.chars&&handler.chars(decodeEntities(text)))}if(html==last)throw $sanitizeMinErr("badparse","The sanitizer was unable to parse the following block of html: {0}",html);last=html}function parseStartTag(tag,tagName,rest,unary){if(tagName=angular.lowercase(tagName),blockElements[tagName])for(;stack.last()&&inlineElements[stack.last()];)parseEndTag(0,stack.last());optionalEndTagElements[tagName]&&stack.last()==tagName&&parseEndTag(0,tagName),(unary=voidElements[tagName]||!!unary)||stack.push(tagName);var attrs={};rest.replace(ATTR_REGEXP,function(match,name,doubleQuotedValue,singleQuotedValue,unquotedValue){var value=doubleQuotedValue||singleQuotedValue||unquotedValue||"";attrs[name]=decodeEntities(value)}),handler.start&&handler.start(tagName,attrs,unary)}function parseEndTag(tag,tagName){var i,pos=0;if(tagName=angular.lowercase(tagName))for(pos=stack.length-1;0<=pos&&stack[pos]!=tagName;pos--);if(0<=pos){for(i=stack.length-1;pos<=i;i--)handler.end&&handler.end(stack[i]);stack.length=pos}}parseEndTag()}(html,htmlSanitizeWriter(buf,function(uri,isImage){return!/^unsafe/.test($$sanitizeUri(uri,isImage))})),buf.join("")}}]}),angular.module("ngSanitize").filter("linky",["$sanitize",function($sanitize){var LINKY_URL_REGEXP=/((ftp|https?):\/\/|(www\.)|(mailto:)?[A-Za-z0-9._%+-]+@)\S*[^\s.;,(){}<>"”’]/,MAILTO_REGEXP=/^mailto:/;return function(text,target){if(!text)return text;for(var match,url,i,raw=text,html=[];match=raw.match(LINKY_URL_REGEXP);)url=match[0],match[2]||match[4]||(url=(match[3]?"http://":"mailto:")+url),i=match.index,addText(raw.substr(0,i)),addLink(url,match[0].replace(MAILTO_REGEXP,"")),raw=raw.substring(i+match[0].length);return addText(raw),$sanitize(html.join(""));function addText(text){var chars,buf;text&&html.push((chars=text,htmlSanitizeWriter(buf=[],angular.noop).chars(chars),buf.join("")))}function addLink(url,text){html.push("<a "),angular.isDefined(target)&&html.push('target="',target,'" '),html.push('href="',url.replace(/"/g,"&quot;"),'">'),addText(text),html.push("</a>")}}}])}((window,window.angular));var taTools={};function registerTextAngularTool(name,toolDefinition){if(!name||""===name||taTools.hasOwnProperty(name))throw"textAngular Error: A unique name is required for a Tool Definition";if(toolDefinition.display&&(""===toolDefinition.display||!validElementString(toolDefinition.display))||!toolDefinition.display&&!toolDefinition.buttontext&&!toolDefinition.iconclass)throw'textAngular Error: Tool Definition for "'+name+'" does not have a valid display/iconclass/buttontext value';taTools[name]=toolDefinition}angular.module("textAngularSetup",[]).constant("taRegisterTool",registerTextAngularTool).value("taTools",taTools).value("taOptions",{forceTextAngularSanitize:!0,keyMappings:[],toolbar:[["h1","h2","h3","h4","h5","h6","p","pre","quote"],["bold","italics","underline","strikeThrough","ul","ol","redo","undo","clear"],["justifyLeft","justifyCenter","justifyRight","justifyFull","indent","outdent"],["html","insertImage","insertLink","insertVideo","wordcount","charcount"]],classes:{focussed:"focussed",toolbar:"btn-toolbar",toolbarGroup:"btn-group",toolbarButton:"btn btn-default",toolbarButtonActive:"active",disabled:"disabled",textEditor:"form-control",htmlEditor:"form-control"},defaultTagAttributes:{a:{target:""}},setup:{textEditorSetup:function(){},htmlEditorSetup:function(){}},defaultFileDropHandler:function(file,insertAction){var reader=new FileReader;return"image"===file.type.substring(0,5)&&(reader.onload=function(){""!==reader.result&&insertAction("insertImage",reader.result,!0)},reader.readAsDataURL(file),!0)}}).value("taSelectableElements",["a","img"]).value("taCustomRenderers",[{selector:"img",customAttribute:"ta-insert-video",renderLogic:function(element){var iframe=angular.element("<iframe></iframe>"),attributes=element.prop("attributes");angular.forEach(attributes,function(attr){iframe.attr(attr.name,attr.value)}),iframe.attr("src",iframe.attr("ta-insert-video")),element.replaceWith(iframe)}}]).value("taTranslations",{html:{tooltip:"Toggle html / Rich Text"},heading:{tooltip:"Heading "},p:{tooltip:"Paragraph"},pre:{tooltip:"Preformatted text"},ul:{tooltip:"Unordered List"},ol:{tooltip:"Ordered List"},quote:{tooltip:"Quote/unquote selection or paragraph"},undo:{tooltip:"Undo"},redo:{tooltip:"Redo"},bold:{tooltip:"Bold"},italic:{tooltip:"Italic"},underline:{tooltip:"Underline"},strikeThrough:{tooltip:"Strikethrough"},justifyLeft:{tooltip:"Align text left"},justifyRight:{tooltip:"Align text right"},justifyFull:{tooltip:"Justify text"},justifyCenter:{tooltip:"Center"},indent:{tooltip:"Increase indent"},outdent:{tooltip:"Decrease indent"},clear:{tooltip:"Clear formatting"},insertImage:{dialogPrompt:"Please enter an image URL to insert",tooltip:"Insert image",hotkey:"the - possibly language dependent hotkey ... for some future implementation"},insertVideo:{tooltip:"Insert video",dialogPrompt:"Please enter a youtube URL to embed"},insertLink:{tooltip:"Insert / edit link",dialogPrompt:"Please enter a URL to insert"},editLink:{reLinkButton:{tooltip:"Relink"},unLinkButton:{tooltip:"Unlink"},targetToggle:{buttontext:"Open in New Window"}},wordcount:{tooltip:"Display words Count"},charcount:{tooltip:"Display characters Count"}}).factory("taToolFunctions",["$window","taTranslations",function($window,taTranslations){return{imgOnSelectAction:function(event,$element,editorScope){var finishEdit=function(){editorScope.updateTaBindtaTextElement(),editorScope.hidePopover()};event.preventDefault(),editorScope.displayElements.popover.css("width","375px");var container=editorScope.displayElements.popoverContainer;container.empty();var buttonGroup=angular.element('<div class="btn-group" style="padding-right: 6px;">'),fullButton=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1">100% </button>');fullButton.on("click",function(event){event.preventDefault(),$element.css({width:"100%",height:""}),finishEdit()});var halfButton=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1">50% </button>');halfButton.on("click",function(event){event.preventDefault(),$element.css({width:"50%",height:""}),finishEdit()});var quartButton=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1">25% </button>');quartButton.on("click",function(event){event.preventDefault(),$element.css({width:"25%",height:""}),finishEdit()});var resetButton=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1">Reset</button>');resetButton.on("click",function(event){event.preventDefault(),$element.css({width:"",height:""}),finishEdit()}),buttonGroup.append(fullButton),buttonGroup.append(halfButton),buttonGroup.append(quartButton),buttonGroup.append(resetButton),container.append(buttonGroup),buttonGroup=angular.element('<div class="btn-group" style="padding-right: 6px;">');var floatLeft=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1"><i class="fa fa-align-left"></i></button>');floatLeft.on("click",function(event){event.preventDefault(),$element.css("float","left"),$element.css("cssFloat","left"),$element.css("styleFloat","left"),finishEdit()});var floatRight=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1"><i class="fa fa-align-right"></i></button>');floatRight.on("click",function(event){event.preventDefault(),$element.css("float","right"),$element.css("cssFloat","right"),$element.css("styleFloat","right"),finishEdit()});var floatNone=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1"><i class="fa fa-align-justify"></i></button>');floatNone.on("click",function(event){event.preventDefault(),$element.css("float",""),$element.css("cssFloat",""),$element.css("styleFloat",""),finishEdit()}),buttonGroup.append(floatLeft),buttonGroup.append(floatNone),buttonGroup.append(floatRight),container.append(buttonGroup),buttonGroup=angular.element('<div class="btn-group">');var remove=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1"><i class="fa fa-trash-o"></i></button>');remove.on("click",function(event){event.preventDefault(),$element.remove(),finishEdit()}),buttonGroup.append(remove),container.append(buttonGroup),editorScope.showPopover($element),editorScope.showResizeOverlay($element)},aOnSelectAction:function(event,$element,editorScope){event.preventDefault(),editorScope.displayElements.popover.css("width","436px");var container=editorScope.displayElements.popoverContainer;container.empty(),container.css("line-height","28px");var link=angular.element('<a href="'+$element.attr("href")+'" target="_blank">'+$element.attr("href")+"</a>");link.css({display:"inline-block","max-width":"200px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap","vertical-align":"middle"}),container.append(link);var buttonGroup=angular.element('<div class="btn-group pull-right">'),reLinkButton=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" tabindex="-1" unselectable="on" title="'+taTranslations.editLink.reLinkButton.tooltip+'"><i class="fa fa-edit icon-edit"></i></button>');reLinkButton.on("click",function(event){event.preventDefault();var urlLink=$window.prompt(taTranslations.insertLink.dialogPrompt,$element.attr("href"));urlLink&&""!==urlLink&&"http://"!==urlLink&&($element.attr("href",urlLink),editorScope.updateTaBindtaTextElement()),editorScope.hidePopover()}),buttonGroup.append(reLinkButton);var unLinkButton=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" tabindex="-1" unselectable="on" title="'+taTranslations.editLink.unLinkButton.tooltip+'"><i class="fa fa-unlink icon-unlink"></i></button>');unLinkButton.on("click",function(event){event.preventDefault(),$element.replaceWith($element.contents()),editorScope.updateTaBindtaTextElement(),editorScope.hidePopover()}),buttonGroup.append(unLinkButton);var targetToggle=angular.element('<button type="button" class="btn btn-default btn-sm btn-small" tabindex="-1" unselectable="on">'+taTranslations.editLink.targetToggle.buttontext+"</button>");"_blank"===$element.attr("target")&&targetToggle.addClass("active"),targetToggle.on("click",function(event){event.preventDefault(),$element.attr("target","_blank"===$element.attr("target")?"":"_blank"),targetToggle.toggleClass("active"),editorScope.updateTaBindtaTextElement()}),buttonGroup.append(targetToggle),container.append(buttonGroup),editorScope.showPopover($element)},extractYoutubeVideoId:function(url){var match=url.match(/(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/i);return match&&match[1]||null}}}]).run(["taRegisterTool","$window","taTranslations","taSelection","taToolFunctions","$sanitize","taOptions","$log",function(taRegisterTool,$window,taTranslations,taSelection,taToolFunctions,$sanitize,taOptions,$log){var gv={};if($sanitize("",gv),!0===taOptions.forceTextAngularSanitize&&"taSanitize"!==gv.version)throw angular.$$minErr("textAngular")("textAngularSetup","The textAngular-sanitize provider has been replaced by another -- have you included angular-sanitize by mistake?");taRegisterTool("html",{iconclass:"fa fa-code",tooltiptext:taTranslations.html.tooltip,action:function(){this.$editor().switchView()},activeState:function(){return this.$editor().showHtml}});var headerAction=function(){return this.$editor().wrapSelection("formatBlock","<"+this.name.toUpperCase()+">")};angular.forEach(["h1","h2","h3","h4","h5","h6"],function(h){var q;taRegisterTool(h.toLowerCase(),{buttontext:h.toUpperCase(),tooltiptext:taTranslations.heading.tooltip+h.charAt(1),action:headerAction,activeState:(q=h.toLowerCase(),function(){return this.$editor().queryFormatBlockState(q)})})}),taRegisterTool("p",{buttontext:"P",tooltiptext:taTranslations.p.tooltip,action:function(){return this.$editor().wrapSelection("formatBlock","<P>")},activeState:function(){return this.$editor().queryFormatBlockState("p")}}),taRegisterTool("pre",{buttontext:"pre",tooltiptext:taTranslations.pre.tooltip,action:function(){return this.$editor().wrapSelection("formatBlock","<PRE>")},activeState:function(){return this.$editor().queryFormatBlockState("pre")}}),taRegisterTool("ul",{iconclass:"fa fa-list-ul",tooltiptext:taTranslations.ul.tooltip,action:function(){return this.$editor().wrapSelection("insertUnorderedList",null)},activeState:function(){return this.$editor().queryCommandState("insertUnorderedList")}}),taRegisterTool("ol",{iconclass:"fa fa-list-ol",tooltiptext:taTranslations.ol.tooltip,action:function(){return this.$editor().wrapSelection("insertOrderedList",null)},activeState:function(){return this.$editor().queryCommandState("insertOrderedList")}}),taRegisterTool("quote",{iconclass:"fa fa-quote-right",tooltiptext:taTranslations.quote.tooltip,action:function(){return this.$editor().wrapSelection("formatBlock","<BLOCKQUOTE>")},activeState:function(){return this.$editor().queryFormatBlockState("blockquote")}}),taRegisterTool("undo",{iconclass:"fa fa-undo",tooltiptext:taTranslations.undo.tooltip,action:function(){return this.$editor().wrapSelection("undo",null)}}),taRegisterTool("redo",{iconclass:"fa fa-repeat",tooltiptext:taTranslations.redo.tooltip,action:function(){return this.$editor().wrapSelection("redo",null)}}),taRegisterTool("bold",{iconclass:"fa fa-bold",tooltiptext:taTranslations.bold.tooltip,action:function(){return this.$editor().wrapSelection("bold",null)},activeState:function(){return this.$editor().queryCommandState("bold")},commandKeyCode:98}),taRegisterTool("justifyLeft",{iconclass:"fa fa-align-left",tooltiptext:taTranslations.justifyLeft.tooltip,action:function(){return this.$editor().wrapSelection("justifyLeft",null)},activeState:function(commonElement){if(commonElement&&"#document"===commonElement.nodeName)return!1;var result=!1;if(commonElement)try{result="left"===commonElement.css("text-align")||"left"===commonElement.attr("align")||"right"!==commonElement.css("text-align")&&"center"!==commonElement.css("text-align")&&"justify"!==commonElement.css("text-align")&&!this.$editor().queryCommandState("justifyRight")&&!this.$editor().queryCommandState("justifyCenter")&&!this.$editor().queryCommandState("justifyFull")}catch(e){result=!1}return result=result||this.$editor().queryCommandState("justifyLeft")}}),taRegisterTool("justifyRight",{iconclass:"fa fa-align-right",tooltiptext:taTranslations.justifyRight.tooltip,action:function(){return this.$editor().wrapSelection("justifyRight",null)},activeState:function(commonElement){if(commonElement&&"#document"===commonElement.nodeName)return!1;var result=!1;if(commonElement)try{result="right"===commonElement.css("text-align")}catch(e){result=!1}return result=result||this.$editor().queryCommandState("justifyRight")}}),taRegisterTool("justifyFull",{iconclass:"fa fa-align-justify",tooltiptext:taTranslations.justifyFull.tooltip,action:function(){return this.$editor().wrapSelection("justifyFull",null)},activeState:function(commonElement){var result=!1;if(commonElement)try{result="justify"===commonElement.css("text-align")}catch(e){result=!1}return result=result||this.$editor().queryCommandState("justifyFull")}}),taRegisterTool("justifyCenter",{iconclass:"fa fa-align-center",tooltiptext:taTranslations.justifyCenter.tooltip,action:function(){return this.$editor().wrapSelection("justifyCenter",null)},activeState:function(commonElement){if(commonElement&&"#document"===commonElement.nodeName)return!1;var result=!1;if(commonElement)try{result="center"===commonElement.css("text-align")}catch(e){result=!1}return result=result||this.$editor().queryCommandState("justifyCenter")}}),taRegisterTool("indent",{iconclass:"fa fa-indent",tooltiptext:taTranslations.indent.tooltip,action:function(){return this.$editor().wrapSelection("indent",null)},activeState:function(){return this.$editor().queryFormatBlockState("blockquote")},commandKeyCode:"TabKey"}),taRegisterTool("outdent",{iconclass:"fa fa-outdent",tooltiptext:taTranslations.outdent.tooltip,action:function(){return this.$editor().wrapSelection("outdent",null)},activeState:function(){return!1},commandKeyCode:"ShiftTabKey"}),taRegisterTool("italics",{iconclass:"fa fa-italic",tooltiptext:taTranslations.italic.tooltip,action:function(){return this.$editor().wrapSelection("italic",null)},activeState:function(){return this.$editor().queryCommandState("italic")},commandKeyCode:105}),taRegisterTool("underline",{iconclass:"fa fa-underline",tooltiptext:taTranslations.underline.tooltip,action:function(){return this.$editor().wrapSelection("underline",null)},activeState:function(){return this.$editor().queryCommandState("underline")},commandKeyCode:117}),taRegisterTool("strikeThrough",{iconclass:"fa fa-strikethrough",tooltiptext:taTranslations.strikeThrough.tooltip,action:function(){return this.$editor().wrapSelection("strikeThrough",null)},activeState:function(){return document.queryCommandState("strikeThrough")}}),taRegisterTool("clear",{iconclass:"fa fa-ban",tooltiptext:taTranslations.clear.tooltip,action:function(deferred,restoreSelection){var selectedElements;this.$editor().wrapSelection("removeFormat",null);var possibleNodes=angular.element(taSelection.getSelectionElement());selectedElements=taSelection.getAllSelectedElements();function removeListElements(list,pe){list=angular.element(list);var prevElement=pe;return pe||(prevElement=list),angular.forEach(list.children(),function(liElem){if("ul"===liElem.tagName.toLowerCase()||"ol"===liElem.tagName.toLowerCase())prevElement=removeListElements(liElem,prevElement);else{var newElem=angular.element("<p></p>");newElem.html(angular.element(liElem).html()),prevElement.after(newElem),prevElement=newElem}}),list.remove(),prevElement}angular.forEach(selectedElements,function(element){"ul"!==element.nodeName.toLowerCase()&&"ol"!==element.nodeName.toLowerCase()||removeListElements(element)}),angular.forEach(possibleNodes.find("ul"),removeListElements),angular.forEach(possibleNodes.find("ol"),removeListElements);var $editor=this.$editor();angular.forEach(possibleNodes,function recursiveRemoveClass(node){(node=angular.element(node))[0]!==$editor.displayElements.text[0]&&node.removeAttr("class"),angular.forEach(node.children(),recursiveRemoveClass)}),possibleNodes[0]&&"li"!==possibleNodes[0].tagName.toLowerCase()&&"ol"!==possibleNodes[0].tagName.toLowerCase()&&"ul"!==possibleNodes[0].tagName.toLowerCase()&&"true"!==possibleNodes[0].getAttribute("contenteditable")&&this.$editor().wrapSelection("formatBlock","default"),restoreSelection()}});var blockJavascript=function(link){return-1!==link.toLowerCase().indexOf("javascript")};taRegisterTool("insertImage",{iconclass:"fa fa-picture-o",tooltiptext:taTranslations.insertImage.tooltip,action:function(){var imageLink;if((imageLink=$window.prompt(taTranslations.insertImage.dialogPrompt,"http://"))&&""!==imageLink&&"http://"!==imageLink&&!blockJavascript(imageLink)){taSelection.getSelectionElement().tagName&&"a"===taSelection.getSelectionElement().tagName.toLowerCase()&&taSelection.setSelectionAfterElement(taSelection.getSelectionElement());var embed='<img src="'+imageLink+'">';return this.$editor().wrapSelection("insertHTML",embed,!0)}},onElementSelect:{element:"img",action:taToolFunctions.imgOnSelectAction}}),taRegisterTool("insertVideo",{iconclass:"fa fa-youtube-play",tooltiptext:taTranslations.insertVideo.tooltip,action:function(){var urlPrompt;if(urlPrompt=$window.prompt(taTranslations.insertVideo.dialogPrompt,"https://"),!blockJavascript(urlPrompt)&&urlPrompt&&""!==urlPrompt&&"https://"!==urlPrompt&&(videoId=taToolFunctions.extractYoutubeVideoId(urlPrompt),videoId)){var urlLink="https://www.youtube.com/embed/"+videoId,embed='<img class="ta-insert-video" src="https://img.youtube.com/vi/'+videoId+'/hqdefault.jpg" ta-insert-video="'+urlLink+'" contenteditable="false" allowfullscreen="true" frameborder="0" />';return taSelection.getSelectionElement().tagName&&"a"===taSelection.getSelectionElement().tagName.toLowerCase()&&taSelection.setSelectionAfterElement(taSelection.getSelectionElement()),this.$editor().wrapSelection("insertHTML",embed,!0)}},onElementSelect:{element:"img",onlyWithAttrs:["ta-insert-video"],action:taToolFunctions.imgOnSelectAction}}),taRegisterTool("insertLink",{tooltiptext:taTranslations.insertLink.tooltip,iconclass:"fa fa-link",action:function(){var urlLink;if((urlLink=taSelection.getSelectionElement().tagName&&"a"===taSelection.getSelectionElement().tagName.toLowerCase()?$window.prompt(taTranslations.insertLink.dialogPrompt,taSelection.getSelectionElement().href):$window.prompt(taTranslations.insertLink.dialogPrompt,"http://"))&&""!==urlLink&&"http://"!==urlLink&&!blockJavascript(urlLink))return this.$editor().wrapSelection("createLink",urlLink,!0)},activeState:function(commonElement){return!!commonElement&&"A"===commonElement[0].tagName},onElementSelect:{element:"a",action:taToolFunctions.aOnSelectAction}}),taRegisterTool("wordcount",{display:'<div id="toolbarWC" style="display:block; min-width:100px;">Words: <span ng-bind="wordcount"></span></div>',disabled:!0,wordcount:0,activeState:function(){var workingHTML=this.$editor().displayElements.text[0].innerHTML||"",noOfWords=0;return""!==workingHTML.replace(/\s*<[^>]*?>\s*/g,"")&&""!==workingHTML.trim()&&(noOfWords=workingHTML.replace(/<\/?(b|i|em|strong|span|u|strikethrough|a|img|small|sub|sup|label)( [^>*?])?>/gi,"").replace(/(<[^>]*?>\s*<[^>]*?>)/gi," ").replace(/(<[^>]*?>)/gi,"").replace(/\s+/gi," ").match(/\S+/g).length),this.wordcount=noOfWords,this.$editor().wordcount=noOfWords,!1}}),taRegisterTool("charcount",{display:'<div id="toolbarCC" style="display:block; min-width:120px;">Characters: <span ng-bind="charcount"></span></div>',disabled:!0,charcount:0,activeState:function(){var textElement=this.$editor().displayElements.text,noOfChars=(textElement[0].innerText||textElement[0].textContent).replace(/(\r\n|\n|\r)/gm,"").replace(/^\s+/g," ").replace(/\s+$/g," ").length;return this.charcount=noOfChars,this.$editor().charcount=noOfChars,!1}})}]),angular.module("textAngular.validators",[]).directive("taMaxText",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ctrl){var max=parseInt(scope.$eval(attrs.taMaxText));if(isNaN(max))throw"Max text must be an integer";attrs.$observe("taMaxText",function(value){if(max=parseInt(value),isNaN(max))throw"Max text must be an integer";ctrl.$dirty&&ctrl.$validate()}),ctrl.$validators.taMaxText=function(viewValue){var source=angular.element("<div/>");return source.html(viewValue),source.text().length<=max}}}}).directive("taMinText",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ctrl){var min=parseInt(scope.$eval(attrs.taMinText));if(isNaN(min))throw"Min text must be an integer";attrs.$observe("taMinText",function(value){if(min=parseInt(value),isNaN(min))throw"Min text must be an integer";ctrl.$dirty&&ctrl.$validate()}),ctrl.$validators.taMinText=function(viewValue){var source=angular.element("<div/>");return source.html(viewValue),!source.text().length||source.text().length>=min}}}});
//# sourceMappingURL=textAngular.min.js.map